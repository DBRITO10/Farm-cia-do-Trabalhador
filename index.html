<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    
    <!-- Firebase SDKs V8 (Mantendo compatibilidade com o código) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        
        /* Barra Superior (User/Logout) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .user-info { font-weight: bold; color: #004c99; font-size: 14px; }
        .logout-btn { background-color: #d9534f; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c9302c; }

        /* Menu de Navegação */
        .nav-menu { display: flex; justify-content: space-around; margin-bottom: 30px; padding: 10px 0; border-bottom: 2px solid #004c99; }
        .nav-menu a { text-decoration: none; color: #004c99; font-weight: bold; padding: 8px 15px; border-radius: 5px; transition: background-color 0.3s; }
        .nav-menu a.active, .nav-menu a:hover { background-color: #e6f0ff; }
        
        /* Título */
        h1 { color: #004c99; text-align: center; margin-bottom: 25px; }

        /* Formulário */
        .header-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Tabela de Itens */
        .item-list-container { margin-bottom: 30px; }
        .item-list-container h2 { color: #004c99; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2em; }
        
        .item-row { display: grid; grid-template-columns: 50px 1fr 100px 100px 100px 50px; gap: 10px; align-items: center; margin-bottom: 10px; padding: 5px; border-bottom: 1px dotted #eee; }
        .item-row.header { font-weight: bold; background-color: #f0f4f8; padding: 10px 5px; border-radius: 5px; border-bottom: 2px solid #004c99; }
        
        .item-row input, .item-row select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .item-row .sequence { text-align: center; font-weight: bold; }
        
        .remove-btn, .add-btn { background-color: #d9534f; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .remove-btn:hover { background-color: #c9302c; }
        .add-btn { background-color: #5cb85c; }
        .add-btn:hover { background-color: #4cae4c; }

        .total-section { text-align: right; margin-top: 20px; font-size: 1.5em; font-weight: bold; color: #004c99; border-top: 2px solid #ddd; padding-top: 15px; }

        /* Ações */
        .actions { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        .actions button { padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        .actions button:active { transform: scale(0.98); }
        .draft-btn { background-color: #f0ad4e; color: white; }
        .draft-btn:hover { background-color: #ec971f; }
        .finalize-btn { background-color: #004c99; color: white; }
        .finalize-btn:hover { background-color: #003366; }

        /* Modal Customizado (Alerta/Confirmação) */
        .custom-modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .custom-modal-content {
            background-color: white; padding: 25px; border-radius: 8px;
            width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center; animation: fadeIn 0.3s;
        }
        .custom-modal-content h3 { color: #004c99; margin-top: 0; }
        .custom-modal-actions button {
            padding: 10px 20px; margin: 5px; border: none; border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s; color: white;
        }
        .custom-modal-actions .confirm-yes { background-color: #5cb85c; }
        .custom-modal-actions .confirm-yes:hover { background-color: #4cae4c; }
        .custom-modal-actions .confirm-no { background-color: #f0ad4e; }
        .custom-modal-actions .confirm-no:hover { background-color: #ec971f; }
        .custom-modal-actions .alert-ok { background-color: #004c99; }
        .custom-modal-actions .alert-ok:hover { background-color: #003366; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        /* Responsividade */
        @media (max-width: 600px) {
            .header-fields { grid-template-columns: 1fr; }
            .nav-menu { flex-direction: column; }
            .nav-menu a { margin: 5px 0; text-align: center; }
            .item-row { grid-template-columns: 30px 1fr 80px 80px 80px 30px; font-size: 0.8em; }
            .item-row input, .item-row select { padding: 5px; }
            .actions { flex-direction: column; gap: 10px; }
            .actions button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra Superior -->
        <div class="top-bar">
            <span class="user-info">Carregando usuário...</span>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <!-- Navegação -->
        <div class="nav-menu">
            <a href="index.html" class="active">Novo Pedido</a>
            <a href="historico.html">Histórico</a>
            <a href="rascunhos.html">Rascunhos</a>
            <a href="produtos.html">Catálogo</a>
            <a href="fornecedores.html">Fornecedores</a>
        </div>
        
        <h1>Novo Pedido de Compra</h1>

        <!-- Formulário Principal -->
        <form id="poForm">
            <!-- Cabeçalho do Pedido -->
            <div class="header-fields">
                <div class="form-group">
                    <label for="poNumber">Número do Pedido (PO)</label>
                    <input type="text" id="poNumber" required readonly>
                </div>
                <div class="form-group">
                    <label for="poDate">Data do Pedido</label>
                    <input type="date" id="poDate" required>
                </div>
                <div class="form-group" style="grid-column: 1 / 3;">
                    <label for="supplierSelect">Fornecedor</label>
                    <select id="supplierSelect" required></select>
                </div>
            </div>

            <!-- Lista de Itens -->
            <div class="item-list-container">
                <h2>Itens do Pedido</h2>
                <div class="item-row header">
                    <div class="sequence">#</div>
                    <div class="description">Produto</div>
                    <div class="qty">Qtde.</div>
                    <div class="price">Preço Unit.</div>
                    <div class="total">Total</div>
                    <div></div> <!-- Botão Remover -->
                </div>
                <div id="itemList">
                    <!-- Itens serão injetados aqui -->
                </div>
                <button type="button" class="add-btn" onclick="addItem()">+ Adicionar Item</button>
                
                <div class="total-section">
                    TOTAL GERAL: R$ <span id="grandTotal">0,00</span>
                </div>
            </div>

            <!-- Observações -->
            <div class="form-group">
                <label for="notes">Observações</label>
                <textarea id="notes" rows="3" style="width: 100%;"></textarea>
            </div>

            <!-- Ações -->
            <div class="actions">
                <button type="button" class="draft-btn" onclick="saveAsDraft()">Memorizar (Rascunho)</button>
                <button type="button" class="finalize-btn" onclick="saveAndFinalize()">Finalizar e Salvar</button>
            </div>
        </form>
    </div>

    <!-- Modal Customizado (Alerta/Confirmação/Visualização) -->
    <div id="customModal" class="custom-modal-backdrop">
        <div class="custom-modal-content">
            <h3 id="modalTitle">Título</h3>
            <p id="modalMessage">Mensagem</p>
            <div id="modalContent"></div> <!-- Conteúdo para visualização de PO -->
            <div id="modalActions" class="custom-modal-actions">
                <!-- Botões injetados por JS -->
            </div>
        </div>
    </div>

    <script>
        let db;
        let auth;

        // SEUS DADOS DE CONFIGURAÇÃO FORNECIDOS (CORRIGIDO)
        const firebaseConfig = {
            apiKey: "AIzaSyAXKlq9WOs_5_ilfhG13xQwNVwQa6MaBfg",
            authDomain: "farmacia-a6682.firebaseapp.com",
            projectId: "farmacia-a6682",
            storageBucket: "farmacia-a6682.firebasestorage.app",
            messagingSenderId: "144965717217",
            appId: "1:144965717217:web:de43b2316e8b7a25293ba0"
        };
        
        // Variáveis globais para controlar a edição
        let poToEdit = new URLSearchParams(window.location.search).get('po');
        let draftToEdit = new URLSearchParams(window.location.search).get('draft');
        let itemCounter = 0; // Contador global para IDs de item
        
        /* --------------------------------------------------
        * FUNÇÕES DE UTILIDADE E FIREBASE 
        * -------------------------------------------------- */

        // Função auxiliar para obter a referência da coleção do usuário logado
        function getUserCollectionRef(collectionName) {
            const user = auth.currentUser;
            if (!user) {
                // Em caso de erro, redireciona para login (tecnicamente o onAuthStateChanged já faria isso)
                window.location.href = 'login.html';
                throw new Error("Usuário não autenticado.");
            }
            // Cria o caminho: 'users/{UID_DO_USUARIO}/[collectionName]'
            return db.collection('users').doc(user.uid).collection(collectionName);
        }

        // --------------------------------------------------
        // Configuração e Autenticação do Firebase
        // --------------------------------------------------
        function setupFirebase() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            auth = firebase.auth();
            db = firebase.firestore();

            // Listener de autenticação: verifica se o usuário está logado
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Usuário logado: exibe info e carrega dados
                    document.querySelector('.user-info').textContent = 'Usuário: ' + (user.email || 'Admin');
                    if (typeof window.loadData === 'function') {
                        window.loadData();
                    }
                } else {
                    // Usuário não logado: redireciona para login
                    if (window.location.pathname.indexOf('login.html') === -1) {
                        window.location.href = 'login.html';
                    }
                }
            });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Erro ao fazer logout:", error);
            });
        }
        window.logout = logout; // Exporta para o HTML

        // Funções de Modal (Alerta/Confirmação)
        let resolveModalPromise;
        
        function setupModal() {
            const modal = document.getElementById('customModal');
            modal.addEventListener('click', (e) => {
                // Fechar apenas se clicar no backdrop, não no conteúdo
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        function showCustomAlert(title, message, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalContent').innerHTML = ''; // Limpa conteúdo de visualização
            
            const actions = document.getElementById('modalActions');
            actions.innerHTML = `<button class="alert-ok" onclick="closeModal()">OK</button>`;

            modal.style.display = 'flex';
            if (callback) {
                resolveModalPromise = callback;
            } else {
                resolveModalPromise = null;
            }
        }

        function showCustomConfirm(title, message, onYes) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalContent').innerHTML = ''; // Limpa conteúdo de visualização
            
            const actions = document.getElementById('modalActions');
            actions.innerHTML = `
                <button class="confirm-yes" id="modalConfirmYes">Sim</button>
                <button class="confirm-no" onclick="closeModal()">Não</button>
            `;

            document.getElementById('modalConfirmYes').onclick = () => {
                closeModal();
                onYes();
            };

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
            if (resolveModalPromise) {
                resolveModalPromise();
                resolveModalPromise = null;
            }
        }
        
        /* --------------------------------------------------
        * FUNÇÕES DE DADOS (CARREGAMENTO DE LISTAS)
        * -------------------------------------------------- */

        // Carrega o seletor de fornecedores
        async function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">Selecione um Fornecedor</option>';

            try {
                const snapshot = await getUserCollectionRef('suppliers').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.cnpj; // CNPJ como valor único
                    option.textContent = data.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar fornecedores:", error);
                showCustomAlert('Erro', 'Não foi possível carregar a lista de fornecedores.');
            }
        }

        // Carrega o seletor de produtos
        async function loadProductSelect() {
            const select = document.getElementById('templateProductSelect'); // Pega o template
            select.innerHTML = '<option value="">Selecione o Produto</option>';

            try {
                const snapshot = await getUserCollectionRef('products').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.sku; // SKU como valor único
                    option.setAttribute('data-price', data.price); // Armazena o preço
                    option.textContent = `${data.name} (R$ ${data.price.replace('.', ',')})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
                showCustomAlert('Erro', 'Não foi possível carregar a lista de produtos.');
            }
        }

        /* --------------------------------------------------
        * FUNÇÕES DE LÓGICA DO PEDIDO
        * -------------------------------------------------- */

        function getNextPoNumber() {
             return getUserCollectionRef('poCounter').doc('current').get().then(doc => {
                if (doc.exists) {
                    return doc.data().lastNumber + 1;
                }
                // Se não existir, começa em 1001 (ou outro valor inicial)
                return 1001; 
            }).catch(error => {
                console.error("Erro ao obter contador:", error);
                // Retorna um valor padrão ou um timestamp em caso de falha crítica
                return Math.floor(Date.now() / 1000); 
            });
        }

        function resequenceItems() {
            const rows = document.querySelectorAll('#itemList .item-row:not(.header)');
            rows.forEach((row, index) => {
                row.querySelector('.sequence').textContent = index + 1;
            });
            calculateTotal();
        }

        function addItem(productSku = '', quantity = '', unitPrice = '', itemTotal = '') {
            itemCounter++;
            const itemList = document.getElementById('itemList');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.setAttribute('data-id', itemCounter);

            // Clonar o seletor de produtos do template
            const productSelectTemplate = document.createElement('select');
            productSelectTemplate.innerHTML = document.getElementById('templateProductSelect').innerHTML;
            productSelectTemplate.className = 'product-select';
            productSelectTemplate.setAttribute('required', true);
            productSelectTemplate.value = productSku;

            newRow.innerHTML = `
                <div class="sequence">${itemList.children.length + 1}</div>
                <div class="description">
                    <!-- O select real será adicionado aqui via JS -->
                </div>
                <div class="qty">
                    <input type="number" value="${quantity}" min="1" step="1" placeholder="Qtde" oninput="calculateTotal()" required>
                </div>
                <div class="price">
                    <input type="text" value="${unitPrice}" placeholder="0,00" oninput="formatPrice(this); calculateTotal()" required>
                </div>
                <div class="total">
                    <span class="item-total-display">${itemTotal}</span>
                </div>
                <div class="remove-btn-container">
                    <button type="button" class="remove-btn" onclick="removeItem(${itemCounter})">X</button>
                </div>
            `;
            
            // Adiciona o select (clonado ou do template)
            const descriptionDiv = newRow.querySelector('.description');
            descriptionDiv.appendChild(productSelectTemplate);
            
            // Adiciona o event listener ao novo select
            productSelectTemplate.addEventListener('change', updateItemDescription);
            
            itemList.appendChild(newRow);
            resequenceItems(); // Recalcula a numeração e total
            calculateTotal();
        }
        
        function removeItem(id) {
            const row = document.querySelector(`.item-row[data-id="${id}"]`);
            if (row) {
                row.remove();
                resequenceItems();
            }
        }

        function formatPrice(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não é número
            if (value.length > 2) {
                // Adiciona a vírgula para centavos
                value = value.replace(/(\d{2})$/, ',$1'); 
            } else if (value.length === 1) {
                value = '0,0' + value;
            } else if (value.length === 2) {
                value = '0,' + value;
            }
            input.value = value;
        }

        function updateItemDescription(event) {
            const select = event.target;
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const row = select.closest('.item-row');
            
            if (row && price) {
                // Atualiza o preço unitário com o preço padrão do catálogo
                const priceInput = row.querySelector('.price input');
                priceInput.value = price.replace('.', ',');
            }
            calculateTotal(); // Recalcula quando o produto muda
        }
        
        function calculateTotal() {
            let grandTotal = 0;
            const rows = document.querySelectorAll('#itemList .item-row:not(.header)');

            rows.forEach(row => {
                const qtyInput = row.querySelector('.qty input');
                const priceInput = row.querySelector('.price input');
                const totalDisplay = row.querySelector('.item-total-display');
                
                const qty = parseFloat(qtyInput.value) || 0;
                // Converte preço de R$,## para float
                const priceStr = priceInput.value.replace('.', '').replace(',', '.');
                const price = parseFloat(priceStr) || 0;
                
                const itemTotal = qty * price;
                grandTotal += itemTotal;
                
                // Formata o total do item para exibição (R$,##)
                totalDisplay.textContent = itemTotal.toFixed(2).replace('.', ',');
            });
            
            // Formata o total geral para exibição
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2).replace('.', ',');
        }

        /* --------------------------------------------------
        * FUNÇÕES DE PERSISTÊNCIA (SALVAR/FINALIZAR)
        * -------------------------------------------------- */

        function getOrderData() {
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierSelect = document.getElementById('supplierSelect');
            const supplierCnpj = supplierSelect.value;
            const supplierName = supplierSelect.options[supplierSelect.selectedIndex].textContent;
            const notes = document.getElementById('notes').value;
            const grandTotal = document.getElementById('grandTotal').textContent.replace('.', '').replace(',', '.');
            
            const items = [];
            const rows = document.querySelectorAll('#itemList .item-row:not(.header)');
            rows.forEach(row => {
                const sku = row.querySelector('.product-select').value;
                const name = row.querySelector('.product-select').options[row.querySelector('.product-select').selectedIndex].textContent;
                const quantity = row.querySelector('.qty input').value;
                const priceStr = row.querySelector('.price input').value.replace('.', '').replace(',', '.');
                const totalStr = row.querySelector('.item-total-display').textContent.replace('.', '').replace(',', '.');

                if (sku && quantity) {
                    items.push({
                        sku: sku,
                        name: name,
                        quantity: parseFloat(quantity),
                        unitPrice: parseFloat(priceStr),
                        total: parseFloat(totalStr)
                    });
                }
            });

            if (!poNumber || !poDate || !supplierCnpj || items.length === 0) {
                showCustomAlert('Erro', 'Preencha todos os campos obrigatórios e adicione pelo menos um item.');
                return null;
            }

            return {
                poNumber: poNumber,
                poDate: poDate,
                supplierCnpj: supplierCnpj,
                supplierName: supplierName,
                notes: notes,
                grandTotal: parseFloat(grandTotal),
                items: items,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        async function saveAsDraft() {
            const data = getOrderData();
            if (!data) return;
            
            showCustomConfirm('Memorizar Rascunho', `Deseja memorizar o Pedido N° ${data.poNumber} como Rascunho?`, async () => {
                try {
                    // Salva na coleção 'drafts'
                    await getUserCollectionRef('drafts').doc(data.poNumber).set(data);
                    
                    showCustomAlert('Memorizado!', `Rascunho N° ${data.poNumber} salvo com sucesso.`, () => {
                         window.location.href = 'rascunhos.html';
                    });
                } catch (error) {
                    console.error("Erro ao salvar rascunho:", error);
                    showCustomAlert('Erro', 'Não foi possível salvar como rascunho: ' + error.message);
                }
            });
        }

        async function saveAndFinalize() {
            const data = getOrderData();
            if (!data) return;

            showCustomConfirm('Finalizar e Salvar', `Confirma a finalização e o salvamento do Pedido N° ${data.poNumber} no Histórico?`, async () => {
                try {
                    // 1. Salva na coleção 'orders' (Histórico)
                    await getUserCollectionRef('orders').doc(data.poNumber).set(data);

                    // 2. Atualiza o contador de PO se for um novo pedido (não rascunho)
                    if (!poToEdit && !draftToEdit) {
                        const counterRef = getUserCollectionRef('poCounter').doc('current');
                        await counterRef.set({ lastNumber: parseInt(data.poNumber) }, { merge: true });
                    }
                    
                    // 3. Se for um rascunho que foi finalizado, remove da coleção 'drafts'
                    if (draftToEdit) {
                        await getUserCollectionRef('drafts').doc(draftToEdit).delete();
                    }

                    showCustomAlert('Sucesso!', `Pedido N° ${data.poNumber} finalizado e salvo no Histórico.`, () => {
                        window.location.href = 'historico.html'; // Redireciona para o histórico
                    });
                } catch (error) {
                    console.error("Erro ao finalizar pedido:", error);
                    showCustomAlert('Erro', 'Não foi possível finalizar o pedido: ' + error.message);
                }
            });
        }

        async function loadOrderForEditing(poNumber, collectionName) {
            try {
                const doc = await getUserCollectionRef(collectionName).doc(poNumber).get();
                if (!doc.exists) {
                    showCustomAlert('Erro', `Pedido/Rascunho N° ${poNumber} não encontrado.`);
                    return;
                }
                const data = doc.data();
                
                // Preenche campos do cabeçalho
                document.getElementById('poNumber').value = data.poNumber;
                document.getElementById('poDate').value = data.poDate;
                document.getElementById('supplierSelect').value = data.supplierCnpj;
                document.getElementById('notes').value = data.notes || '';
                
                // Limpa e preenche itens
                document.getElementById('itemList').innerHTML = '';
                itemCounter = 0; // Reseta o contador
                data.items.forEach(item => {
                    const totalFormatted = item.total.toFixed(2).replace('.', ',');
                    const priceFormatted = item.unitPrice.toFixed(2).replace('.', ',');
                    addItem(item.sku, item.quantity, priceFormatted, totalFormatted);
                });
                
                calculateTotal();

            } catch (error) {
                console.error(`Erro ao carregar ${collectionName}:`, error);
                showCustomAlert('Erro', 'Não foi possível carregar os dados para edição.');
            }
        }

        /* --------------------------------------------------
        * INICIALIZAÇÃO
        * -------------------------------------------------- */

        async function init() {
            // Carrega primeiro as listas, pois são necessárias para a interface
            await loadSupplierSelect();
            // Clonar o select para criar o template antes de carregar produtos
            const templateSelect = document.getElementById('supplierSelect').cloneNode(true);
            templateSelect.id = 'templateProductSelect';
            templateSelect.style.display = 'none';
            document.body.appendChild(templateSelect);

            await loadProductSelect();
            
            // Verifica se está editando ou criando novo
            if (poToEdit) {
                await loadOrderForEditing(poToEdit, 'orders');
            } else if (draftToEdit) {
                await loadOrderForEditing(draftToEdit, 'drafts');
            } else {
                // Novo pedido: Define data e número
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = await getNextPoNumber();
                addItem(); // Adiciona um item inicial vazio
            }
        }

        // Função de carregamento que é chamada após a autenticação
        window.loadData = init;

        window.onload = () => {
            setupModal();
            // CHAMA A FUNÇÃO CORRIGIDA
            setupFirebase(); 
        };

        // Exporta funções para uso global (onchange/onclick no HTML)
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.calculateTotal = calculateTotal;
        window.updateItemDescription = updateItemDescription;
        window.saveAsDraft = saveAsDraft;
        window.saveAndFinalize = saveAndFinalize;
        window.resequenceItems = resequenceItems; 
        window.closeModal = closeModal; // Exporta também para o HTML do modal
        window.formatPrice = formatPrice;
    </script>
</body>
</html>
