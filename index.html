<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { text-align: center; margin-bottom: 30px; color: #004c99; }
        .header h1 { font-size: 28px; }
        
        /* Navegação */
        .nav-bar { display: flex; justify-content: space-around; background-color: #004c99; margin-bottom: 20px; border-radius: 4px; }
        .nav-bar a { color: white; padding: 12px 20px; text-decoration: none; font-weight: bold; transition: background-color 0.3s; border-radius: 4px; }
        .nav-bar a:hover, .nav-bar a.active { background-color: #003366; }
        
        /* Estilo do Formulário */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input[type="text"], input[type="date"], input[type="number"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px;
        }
        select { height: 40px; }

        /* Itens do Pedido */
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center; }
        .item-row input, .item-row button { height: 40px; }
        
        /* Botões */
        .action-buttons { margin-top: 25px; text-align: center; }
        .action-buttons button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0 10px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-memorize { background-color: #ffc107; color: #333; }
        .btn-memorize:hover { background-color: #e0a800; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-save:hover { background-color: #1e7e34; }
        .delete-btn { background-color: #dc3545; color: white; padding: 8px 12px; margin-top: 0; }
        .delete-btn:hover { background-color: #c82333; }

        /* Estilos de impressão (Visualização PDF) */
        @media print {
            body { 
                padding: 0; 
                margin: 0;
                background-color: white;
            }
            .container, .nav-bar, .action-buttons, .form-group:not(.print-only) {
                display: none;
            }
            .purchase-order {
                display: block; 
            }
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="index.html" class="active">Criar Pedido</a>
        <a href="fornecedores.html">Cadastrar Fornecedor</a>
        <a href="produtos.html">Cadastrar Produto</a>
        <a href="historico.html">Histórico de Pedidos</a>
    </div>

    <div class="container">
        <div class="header">
            <h1>NOVO PEDIDO DE COMPRA</h1>
        </div>

        <div class="form-group">
            <label for="poNumber">Número do Pedido (PO):</label>
            <input type="text" id="poNumber" value="PO-001">
        </div>
        
        <div class="form-group">
            <label for="poDate">Data do Pedido:</label>
            <input type="date" id="poDate">
        </div>
        
        <hr>
        
        <div class="form-group">
            <label for="supplierSelect">Selecionar Fornecedor:</label>
            <select id="supplierSelect" onchange="loadSupplierData()">
                <option value="">-- Selecione ou Digite Abaixo --</option>
            </select>
        </div>

        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label for="supplierName">Nome do Fornecedor:</label>
                <input type="text" id="supplierName" value="" placeholder="Nome do Fornecedor Ltda.">
            </div>
            <div>
                <label for="supplierContact">Contato/Email:</label>
                <input type="text" id="supplierContact" value="" placeholder="email@fornecedor.com">
            </div>
        </div>
        
        <div class="form-group">
            <label for="deliveryDate">Previsão de Entrega:</label>
            <input type="date" id="deliveryDate">
        </div>

        <hr>

        <label for="items">Itens do Pedido:</label>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="productSelect" style="flex-grow: 1;">
                <option value="">-- Adicionar Produto Cadastrado --</option>
            </select>
            <button onclick="addProductFromSelect()" style="width: 150px; background-color: #007bff;">Adicionar</button>
        </div>
        
        <div id="itemsContainer">
        </div>
        <button onclick="addItem()" style="background-color: #0099cc; width: 100%;">Adicionar Item Manualmente</button>
        
        <div class="form-group" style="margin-top: 20px;">
            <label for="notes">Observações:</label>
            <textarea id="notes" rows="3">Por favor, envie a Nota Fiscal junto com a mercadoria.</textarea>
        </div>
        
        <div class="action-buttons">
            <button class="btn-memorize" onclick="saveDraft()">1. Visualizar Rascunho / Memorizar</button>
            <button class="btn-save" onclick="savePurchaseOrder()">2. Salvar Pedido (Gravar)</button>
        </div>
        
    </div>

    <div class="purchase-order" id="purchaseOrderOutput" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <img 
                src="https://dbrito10.github.io/Farm-cia-do-Trabalhador/Logo.jpg" 
                alt="Logo Farmácia do Trabalhador e Aposentado" 
                style="max-width: 200px; height: auto;" 
            >
            <h1 style="color: #004c99; font-size: 22px; margin: 5px 0 10px 0;">PEDIDO DE COMPRA</h1>
            <div style="font-size: 11px; line-height: 1.5;">
                <p style="margin: 0; font-weight: bold;">FARMÁCIA DO TRABALHADOR E APOSENTADO DE PINHEIROS LTDA | CNPJ: 32.927.077/0001-06</p>
                <p style="margin: 0;">Endereço: PRAC BAIANA 75-B ANEXO B, Centro, Pinheiros/ES, CEP 29980-000</p>
                <p style="margin: 0;">Telefone: (27) 99981-8349</p>
            </div>
            <hr style="border: 1px solid #004c99; margin-top: 10px;">
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px;">
            <div style="font-weight: bold;">
                Pedido N°: <span id="outPoNumber">PO-001</span>
            </div>
            <div>
                Data: <span id="outPoDate">2025-10-05</span>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; font-size: 12px;">
            <div>
                <p style="font-weight: bold; color: #004c99; margin: 0 0 5px 0;">DADOS DO FORNECEDOR</p>
                <div>**Fornecedor:** <span id="outSupplierName"></span></div>
                <div>**Contato:** <span id="outSupplierContact"></span></div>
            </div>
            <div style="text-align: right;">
                <p style="font-weight: bold; color: #004c99; margin: 0 0 5px 0;">DETALHES DA ENTREGA</p>
                <div>**Previsão:** <span id="outDeliveryDate"></span></div>
                <div>**Local:** PRAC BAIANA 75-B ANEXO B</div>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #333; padding: 8px; text-align: left; background-color: #f2f2f2; width: 45%;">Item / Descrição</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 10%;">SKU</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 10%;">Qtd.</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; width: 15%;">Preço Unit. (R$)</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; width: 20%;">Total (R$)</th>
                </tr>
            </thead>
            <tbody id="poTableBody">
            </tbody>
        </table>

        <div style="margin-top: 20px; text-align: right; font-size: 13px;">
            <div>Subtotal: <span id="outSubtotal" style="font-weight: bold;">R$ 0,00</span></div>
            <div style="margin-top: 5px; font-size: 16px; border-top: 1px solid #ccc; padding-top: 5px;">
                **TOTAL GERAL:** <span id="outTotal" style="color: #dc3545;">R$ 0,00</span>
            </div>
        </div>

        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; font-size: 12px;">
            <p style="font-weight: bold; color: #004c99; margin: 0 0 5px 0;">OBSERVAÇÕES:</p>
            <p id="outNotes" style="margin: 0;">Por favor, envie a Nota Fiscal junto com a mercadoria.</p>
        </div>
        
        <div style="margin-top: 40px; text-align: center; font-size: 10px;">
            <hr style="width: 50%; margin: 40px auto 5px auto;">
            <p>Assinatura / Carimbo - FARMÁCIA DO TRABALHADOR E APOSENTADO</p>
        </div>
    </div>
    
    <script>
        // Variável global para armazenar os itens do pedido em rascunho
        let items = [];

        // --- FUNÇÕES DE CADASTRO DE DADOS (USADAS NO INDEX) ---

        function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">-- Selecione ou Digite Abaixo --</option>';
            const suppliers = JSON.parse(localStorage.getItem('suppliers')) || {};
            
            Object.keys(suppliers).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }
        
        function loadSupplierData() {
            const selectedName = document.getElementById('supplierSelect').value;
            if (!selectedName) return;

            const suppliers = JSON.parse(localStorage.getItem('suppliers'));
            const supplier = suppliers[selectedName];

            if (supplier) {
                document.getElementById('supplierName').value = supplier.name || '';
                document.getElementById('supplierContact').value = supplier.contact || '';
            }
        }
        
        function loadProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">-- Adicionar Produto Cadastrado --</option>';
            const products = JSON.parse(localStorage.getItem('products')) || {};
            
            Object.keys(products).forEach(key => {
                const product = products[key];
                const option = document.createElement('option');
                option.value = product.sku;
                option.textContent = `(${product.sku}) ${product.desc} - R$ ${product.price.replace('.', ',')}`;
                select.appendChild(option);
            });
        }
        
        function addProductFromSelect() {
            const selectedSku = document.getElementById('productSelect').value;
            if (!selectedSku) {
                alert("Por favor, selecione um produto do catálogo.");
                return;
            }
            
            const products = JSON.parse(localStorage.getItem('products'));
            const product = products[selectedSku];
            
            if (product) {
                const container = document.getElementById('itemsContainer');
                const newIndex = items.length;
                
                const itemRow = document.createElement('div');
                itemRow.classList.add('item-row');
                itemRow.innerHTML = `
                    <input type="text" id="desc-${newIndex}" value="${product.desc}" placeholder="Descrição do Item">
                    <input type="text" id="sku-${newIndex}" value="${product.sku}" placeholder="SKU/Cód.">
                    <input type="number" id="qty-${newIndex}" value="1" min="1">
                    <input type="number" id="price-${newIndex}" value="${product.price}" min="0" step="0.01">
                    <button class="delete-btn" onclick="removeItem(${newIndex})">X</button>
                `;
                container.appendChild(itemRow);
                
                items.push({ index: newIndex }); 
                // Não chama updateOrder aqui, apenas no saveDraft ou savePurchaseOrder
            }
            document.getElementById('productSelect').value = ""; // Limpa a seleção
        }

        function addItem() {
            const container = document.getElementById('itemsContainer');
            const newIndex = items.length;
            
            const itemRow = document.createElement('div');
            itemRow.classList.add('item-row');
            itemRow.innerHTML = `
                <input type="text" id="desc-${newIndex}" placeholder="Descrição do Item">
                <input type="text" id="sku-${newIndex}" placeholder="SKU/Cód.">
                <input type="number" id="qty-${newIndex}" value="1" min="1">
                <input type="number" id="price-${newIndex}" value="0.00" min="0" step="0.01">
                <button class="delete-btn" onclick="removeItem(${newIndex})">X</button>
            `;
            container.appendChild(itemRow);
            
            items.push({ index: newIndex }); 
        }

        function removeItem(index) {
            const element = document.getElementById(`desc-${index}`).parentNode;
            element.remove();
            items = items.filter(item => item.index !== index);
        }

        // --- FUNÇÕES DE AÇÃO (RASCUNHO E GRAVAÇÃO) ---

        function updateDraft() {
            // Esta função atualiza o PO na estrutura oculta para o PDF
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierName = document.getElementById('supplierName').value;
            const supplierContact = document.getElementById('supplierContact').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value;

            // 1. Atualiza dados principais no PO (estrutura do PDF)
            document.getElementById('outPoNumber').textContent = poNumber || 'N/A';
            document.getElementById('outPoDate').textContent = poDate ? formatDate(poDate) : 'N/A';
            document.getElementById('outSupplierName').textContent = supplierName || 'N/A';
            document.getElementById('outSupplierContact').textContent = supplierContact || 'N/A';
            document.getElementById('outDeliveryDate').textContent = deliveryDate ? formatDate(deliveryDate) : 'N/A';
            document.getElementById('outNotes').textContent = notes || 'Nenhuma observação.';
            
            // 2. Atualiza a tabela de itens no PO
            let total = 0;
            const poTableBody = document.getElementById('poTableBody');
            poTableBody.innerHTML = ''; 

            items.forEach(item => {
                const index = item.index;
                // Deve usar a função '?' para garantir que o elemento existe antes de pegar o valor
                const desc = document.getElementById(`desc-${index}`)?.value || '';
                const sku = document.getElementById(`sku-${index}`)?.value || '';
                const qty = parseFloat(document.getElementById(`qty-${index}`)?.value) || 0;
                const price = parseFloat(document.getElementById(`price-${index}`)?.value) || 0;
                
                if (!desc) return; 
                
                const itemTotal = qty * price;
                total += itemTotal;
                
                const newRow = poTableBody.insertRow();
                newRow.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">**${desc}**</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${sku || 'N/A'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${qty.toLocaleString('pt-BR')}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">R$ ${price.toFixed(2).replace('.', ',')}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">R$ ${itemTotal.toFixed(2).replace('.', ',')}</td>
                `;
            });
            
            // 3. Atualiza os totais
            document.getElementById('outSubtotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('outTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }


        // Memorizar/Visualizar Rascunho
        function saveDraft() {
            updateDraft(); // Atualiza a estrutura do PO
            // Simula a impressão para visualização (que gera o PDF/memoriza)
            window.print();
        }

        // Salvar Pedido (Gravação Definitiva)
        function savePurchaseOrder() {
            const poNumber = document.getElementById('poNumber').value;
            if (!poNumber || poNumber.trim() === '') {
                alert("O número do pedido (PO) é obrigatório para salvar!");
                return;
            }
            if (items.length === 0) {
                 alert("Adicione pelo menos um item ao pedido antes de salvar.");
                return;
            }

            // 1. Atualiza o rascunho (garante que os dados mais recentes estão na memória)
            updateDraft();

            // 2. Coleta o JSON final do pedido
            const orderData = getCurrentOrderData();
            
            // 3. Grava no LocalStorage
            const savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || {};
            
            if (savedOrders[poNumber] && !confirm(`O Pedido N° ${poNumber} já existe. Deseja sobrescrevê-lo?`)) {
                return;
            }
            
            savedOrders[poNumber] = orderData;
            localStorage.setItem('savedOrders', JSON.stringify(savedOrders));

            alert(`Pedido N° ${poNumber} salvo com sucesso! Você será redirecionado para o Histórico.`);
            
            // 4. Redireciona para o histórico
            window.location.href = 'historico.html';
        }

        // Coleta todos os dados atuais do formulário
        function getCurrentOrderData() {
            const orderItems = [];
            items.forEach(item => {
                const index = item.index;
                const desc = document.getElementById(`desc-${index}`)?.value || '';
                if (desc) {
                    orderItems.push({
                        desc: desc,
                        sku: document.getElementById(`sku-${index}`)?.value || '',
                        qty: document.getElementById(`qty-${index}`)?.value || '',
                        price: document.getElementById(`price-${index}`)?.value || ''
                    });
                }
            });

            return {
                poNumber: document.getElementById('poNumber').value,
                poDate: document.getElementById('poDate').value,
                supplierName: document.getElementById('supplierName').value,
                supplierContact: document.getElementById('supplierContact').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                notes: document.getElementById('notes').value,
                items: orderItems
            };
        }

        // Função auxiliar para formatar datas
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // Inicialização
        function init() {
            document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
            
            loadSupplierSelect();
            loadProductSelect();
            addItem(); 

            // Garante que o número do PO seja sequencial (simples)
            const savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || {};
            const lastPoNumber = Object.keys(savedOrders).length;
            document.getElementById('poNumber').value = `PO-${(lastPoNumber + 1).toString().padStart(3, '0')}`;
        }

        window.onload = init;
    </script>
</body>
</html>
