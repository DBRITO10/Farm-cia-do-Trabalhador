<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        
        /* Barra Superior (User/Logout) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .user-info { font-weight: bold; color: #004c99; font-size: 14px; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c82333; }

        .header { text-align: center; margin-bottom: 30px; }
        .header img { max-width: 150px; height: auto; margin-bottom: 10px; }
        .header h1 { color: #004c99; margin: 0; font-size: 24px; }
        .header p { color: #666; font-size: 16px; margin: 5px 0 0; }
        
        /* Formulário */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        .form-group input[type="date"],
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .po-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        /* Tabela de Itens */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .items-table th {
            background-color: #004c99;
            color: white;
            font-weight: normal;
        }
        .items-table td input[type="text"],
        .items-table td input[type="number"],
        .items-table td select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            text-align: center;
        }
        .items-table td.desc-cell { width: 40%; }
        .items-table td.qty-cell { width: 10%; }
        .items-table td.unit-cell { width: 15%; }
        .items-table td.total-cell { width: 15%; }
        .items-table td.action-cell { width: 5%; text-align: center; }

        .btn-add, .remove-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-add:hover { background-color: #218838; }
        .remove-btn { background-color: #dc3545; }
        .remove-btn:hover { background-color: #c82333; }

        /* Rodapé / Totais / Ações */
        .po-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .total-area {
            font-size: 1.2em;
            font-weight: bold;
            color: #004c99;
            border-top: 2px solid #004c99;
            padding-top: 10px;
        }
        .total-area p { margin: 5px 0; }

        .actions {
            display: flex;
            gap: 10px;
        }
        .btn-save, .btn-draft {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        .btn-save {
            background-color: #007bff;
            color: white;
        }
        .btn-save:hover { background-color: #0056b3; }
        .btn-draft {
            background-color: #ffc107;
            color: #333;
        }
        .btn-draft:hover { background-color: #e0a800; }
        
        .disabled { opacity: 0.5; cursor: not-allowed; }

        /* Estilos do Modal (Alertas Customizados) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-content h3 { margin-top: 0; color: #004c99; }
        .modal-buttons { margin-top: 20px; }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-weight: bold;
        }
        .modal-ok-btn { background-color: #007bff; color: white; }
        .modal-cancel-btn { background-color: #6c757d; color: white; }
        .modal-confirm-btn { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <span class="user-info">Carregando Usuário...</span>
            <button class="logout-btn" onclick="firebase.auth().signOut().then(() => { window.location.href = 'login.html'; });">Sair</button>
        </div>

        <nav>
            <a href="index.html">Novo Pedido</a> | 
            <a href="rascunhos.html">Rascunhos</a> | 
            <a href="historico.html">Histórico</a> |
            <a href="produtos.html">Catálogo Produtos</a> | 
            <a href="fornecedores.html">Cadastro Fornecedores</a>
        </nav>

        <div class="header">
            <img src="Logo.jpg" alt="Logo Farmácia do Trabalhador">
            <h1>Pedido de Compra</h1>
            <p>Farmácia do Trabalhador - Matriz</p>
        </div>

        <form id="poForm">
            <div class="po-details">
                <div class="form-group">
                    <label for="poNumber">Nº do Pedido:</label>
                    <input type="text" id="poNumber" name="poNumber" required readonly>
                </div>
                <div class="form-group">
                    <label for="poDate">Data:</label>
                    <input type="date" id="poDate" name="poDate" required>
                </div>
                <div class="form-group">
                    <label for="supplierSelect">Fornecedor:</label>
                    <select id="supplierSelect" name="supplier" required>
                        <option value="">Selecione um Fornecedor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="poDescription">Descrição (Opcional):</label>
                    <input type="text" id="poDescription" name="poDescription">
                </div>
            </div>

            <h2>Itens do Pedido</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Nº</th>
                        <th class="desc-cell">Produto (SKU)</th>
                        <th class="qty-cell">Qtd.</th>
                        <th class="unit-cell">Valor Un.</th>
                        <th class="total-cell">Subtotal</th>
                        <th class="action-cell">Ação</th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    </tbody>
            </table>
            <button type="button" class="btn-add" onclick="addItem()">Adicionar Item</button>

            <div class="po-footer">
                <div class="total-area">
                    <p>Total do Pedido: <span id="poTotal">R$ 0,00</span></p>
                </div>
                <div class="actions">
                    <button type="button" class="btn-draft" onclick="saveAsDraft()">Salvar Rascunho</button>
                    <button type="button" class="btn-save" onclick="saveAndFinalize()">Finalizar Pedido</button>
                </div>
            </div>
        </form>
    </div>

    <div id="customModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Título</h3>
            <p id="modalMessage">Mensagem.</p>
            <div class="modal-buttons" id="modalButtons">
                <button class="modal-ok-btn" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // SEUS DADOS DE CONFIGURAÇÃO FORNECIDOS (Copiei de login.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAXKlq9WOs_5_ilfhG13xQwNVwQa6MaBfg",
            authDomain: "farmacia-a6682.firebaseapp.com",
            projectId: "farmacia-a6682",
            storageBucket: "farmacia-a6682.firebasestorage.app",
            messagingSenderId: "144965717217",
            appId: "1:144965717217:web:de43b2316e8b7a25293ba0"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variáveis globais para os dados carregados
        let suppliersList = {};
        let productsCatalog = {};

        // --- Funções de Utilitários (Copiei de historico.html/login.html) ---

        function setupModal() {
            window.customModal = document.getElementById('customModal');
            window.modalTitle = document.getElementById('modalTitle');
            window.modalMessage = document.getElementById('modalMessage');
            window.modalButtons = document.getElementById('modalButtons');
        }

        function closeModal() {
            if (window.customModal) {
                window.customModal.style.display = 'none';
            }
        }

        function showCustomAlert(title, message, callback) {
            window.modalTitle.textContent = title;
            window.modalMessage.textContent = message;
            window.modalButtons.innerHTML = `<button class="modal-ok-btn" onclick="closeModal(); ${callback ? 'window.alertCallback();' : ''}">OK</button>`;
            if (callback) {
                window.alertCallback = callback;
            }
            window.customModal.style.display = 'block';
        }
        
        function showCustomConfirm(title, message, onConfirm, onCancel) {
            window.modalTitle.textContent = title;
            window.modalMessage.textContent = message;
            window.modalButtons.innerHTML = `
                <button class="modal-confirm-btn" onclick="closeModal(); window.confirmCallback(true);">Confirmar</button>
                <button class="modal-cancel-btn" onclick="closeModal(); window.confirmCallback(false);">Cancelar</button>
            `;
            window.confirmCallback = (isConfirmed) => {
                if (isConfirmed && onConfirm) {
                    onConfirm();
                } else if (!isConfirmed && onCancel) {
                    onCancel();
                }
            };
            window.customModal.style.display = 'block';
        }

        function formatCurrency(value) {
            const num = parseFloat(String(value).replace(',', '.'));
            if (isNaN(num)) return 'R$ 0,00';
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // --- Autenticação Corrigida ---

        function getUserCollectionRef(collectionName) {
            const user = auth.currentUser;
            if (!user) {
                // Se a função for chamada antes do auth.onAuthStateChanged ser resolvido, isso garante o erro
                throw new Error("Usuário não autenticado para acessar o Firestore.");
            }
            // Usa o UID do usuário para isolar os dados
            return db.collection('users').doc(user.uid).collection(collectionName);
        }

        // FUNÇÃO CRÍTICA: CORREÇÃO DO LOOP INFINITO
        function setupFirebase() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Usuário logado:
                    const userInfoElement = document.querySelector('.user-info');
                    if (userInfoElement) {
                        userInfoElement.textContent = 'Usuário: ' + user.email;
                    }
                    
                    // Chama a função de carregamento de dados específica desta página
                    if (window.loadData) {
                        window.loadData();
                    }

                } else {
                    // Usuário NÃO logado: Redireciona para a página de login
                    window.location.href = 'login.html';
                }
            });
        }

        // --- Funções Específicas da Página ---

        // Função para carregar a lista de fornecedores
        async function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">Selecione um Fornecedor</option>';

            try {
                const snapshot = await getUserCollectionRef('suppliers').get();
                suppliersList = {}; // Limpa a lista global
                snapshot.forEach(doc => {
                    const supplier = doc.data();
                    suppliersList[supplier.cnpj] = supplier; // Armazena por CNPJ
                    const option = document.createElement('option');
                    option.value = supplier.cnpj;
                    option.textContent = `${supplier.name} (${supplier.cnpj})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar fornecedores:", error);
                showCustomAlert('Erro', 'Não foi possível carregar a lista de fornecedores.');
            }
        }

        // Função para carregar o catálogo de produtos
        async function loadProductSelect() {
            try {
                const snapshot = await getUserCollectionRef('products').get();
                productsCatalog = {}; // Limpa o catálogo global
                snapshot.forEach(doc => {
                    const product = doc.data();
                    productsCatalog[product.sku] = product; // Armazena por SKU
                });
                // Recarrega todos os selects de produto existentes
                resequenceItems(); 
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o catálogo de produtos.');
            }
        }

        // Função para obter o próximo número de PO
        async function getNextPoNumber() {
            try {
                const counterDoc = await getUserCollectionRef('meta').doc('poCounter').get();
                if (counterDoc.exists) {
                    return counterDoc.data().nextNumber.toString().padStart(6, '0');
                } else {
                    // Inicializa se não existir
                    await getUserCollectionRef('meta').doc('poCounter').set({ nextNumber: 1 });
                    return '000001';
                }
            } catch (error) {
                console.error("Erro ao obter o próximo número de PO:", error);
                showCustomAlert('Erro', 'Não foi possível gerar o número do pedido.');
                return 'ERRO00';
            }
        }

        // Função para atualizar o contador de PO
        async function updatePoCounter() {
            try {
                const counterDocRef = getUserCollectionRef('meta').doc('poCounter');
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(counterDocRef);
                    if (doc.exists) {
                        const newNumber = doc.data().nextNumber + 1;
                        transaction.update(counterDocRef, { nextNumber: newNumber });
                    } else {
                        // Isso só deve acontecer na primeira vez
                        transaction.set(counterDocRef, { nextNumber: 2 });
                    }
                });
            } catch (error) {
                console.error("Erro ao atualizar contador de PO:", error);
                // Permite a finalização, mas loga o erro
            }
        }

        // Função para adicionar uma nova linha de item
        function addItem(productData = {}) {
            const itemsBody = document.getElementById('itemsBody');
            const newRow = itemsBody.insertRow();
            newRow.setAttribute('data-item-index', itemsBody.rows.length);

            // Célula Nº
            const numCell = newRow.insertCell();
            numCell.textContent = itemsBody.rows.length;
            numCell.classList.add('item-num');

            // Célula Produto/Descrição
            const descCell = newRow.insertCell();
            descCell.classList.add('desc-cell');
            const select = document.createElement('select');
            select.classList.add('item-product');
            select.onchange = (e) => updateItemDescription(e.target);
            select.innerHTML = '<option value="">Selecione um Produto</option>';
            for (const sku in productsCatalog) {
                const option = document.createElement('option');
                option.value = sku;
                option.textContent = `${sku} - ${productsCatalog[sku].desc}`;
                select.appendChild(option);
            }
            select.value = productData.sku || '';

            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.placeholder = 'Descrição (preenchimento automático)';
            descriptionInput.classList.add('item-desc');
            descriptionInput.value = productData.desc || '';
            descriptionInput.disabled = true; // Mantém desabilitado para garantir o uso do catálogo
            
            descCell.appendChild(select);
            descCell.appendChild(descriptionInput);
            
            // Célula Quantidade
            const qtyCell = newRow.insertCell();
            qtyCell.classList.add('qty-cell');
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = '1';
            qtyInput.value = productData.qty || '1';
            qtyInput.onchange = calculateTotal;
            qtyCell.appendChild(qtyInput);

            // Célula Valor Unitário
            const unitCell = newRow.insertCell();
            unitCell.classList.add('unit-cell');
            const unitInput = document.createElement('input');
            unitInput.type = 'text';
            unitInput.classList.add('item-unit-price');
            unitInput.value = (productData.unitPrice || '0.00').replace('.', ',');
            unitInput.onchange = calculateTotal;
            unitCell.appendChild(unitInput);

            // Célula Subtotal
            const totalCell = newRow.insertCell();
            totalCell.classList.add('total-cell');
            totalCell.textContent = formatCurrency(productData.subTotal || 0);

            // Célula Ação (Remover)
            const actionCell = newRow.insertCell();
            actionCell.classList.add('action-cell');
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.classList.add('remove-btn');
            removeButton.textContent = 'X';
            removeButton.onclick = () => removeItem(newRow);
            actionCell.appendChild(removeButton);

            // Preenche os dados iniciais do produto se um SKU foi carregado
            if (productData.sku) {
                 updateItemDescription(select);
            }

            calculateTotal(); // Recalcula o total geral
        }

        // Função para remover uma linha de item
        function removeItem(row) {
            row.remove();
            resequenceItems();
            calculateTotal();
        }

        // Função para resequenciar os itens da tabela (após remoção)
        function resequenceItems() {
            const itemsBody = document.getElementById('itemsBody');
            for (let i = 0; i < itemsBody.rows.length; i++) {
                const row = itemsBody.rows[i];
                row.cells[0].textContent = i + 1; // Atualiza o número da linha
            }
        }

        // Função para atualizar descrição e preço ao selecionar o produto
        function updateItemDescription(selectElement) {
            const sku = selectElement.value;
            const row = selectElement.closest('tr');
            
            const descriptionInput = row.querySelector('.item-desc');
            const unitPriceInput = row.querySelector('.item-unit-price');
            
            if (sku && productsCatalog[sku]) {
                const product = productsCatalog[sku];
                descriptionInput.value = product.desc;
                unitPriceInput.value = product.price.replace('.', ',');
            } else {
                descriptionInput.value = '';
                unitPriceInput.value = '0,00';
            }

            calculateTotal(); // Recalcula após a mudança
        }

        // Função para calcular o total do pedido
        function calculateTotal() {
            const itemsBody = document.getElementById('itemsBody');
            let grandTotal = 0;

            for (let i = 0; i < itemsBody.rows.length; i++) {
                const row = itemsBody.rows[i];
                const qtyInput = row.cells[2].querySelector('input');
                const unitInput = row.cells[3].querySelector('input');
                const totalCell = row.cells[4];

                const qty = parseInt(qtyInput.value) || 0;
                // Converte de R$X,XX para número
                const unitPrice = parseFloat(unitInput.value.replace('.', '').replace(',', '.')) || 0;

                const subTotal = qty * unitPrice;
                grandTotal += subTotal;

                totalCell.textContent = formatCurrency(subTotal);
            }

            document.getElementById('poTotal').textContent = formatCurrency(grandTotal);
        }

        // Função para coletar os dados do formulário
        function collectFormData(status) {
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierCnpj = document.getElementById('supplierSelect').value;
            const poDescription = document.getElementById('poDescription').value;
            const supplier = suppliersList[supplierCnpj] || { name: 'Desconhecido', cnpj: supplierCnpj };

            const items = [];
            const itemsBody = document.getElementById('itemsBody');
            for (let i = 0; i < itemsBody.rows.length; i++) {
                const row = itemsBody.rows[i];
                const sku = row.cells[1].querySelector('.item-product').value;
                const desc = row.cells[1].querySelector('.item-desc').value;
                const qty = parseInt(row.cells[2].querySelector('input').value) || 0;
                const unitPrice = parseFloat(row.cells[3].querySelector('input').value.replace('.', '').replace(',', '.')) || 0;
                
                // Validação mínima para garantir que o item é válido
                if (sku && desc && qty > 0 && unitPrice >= 0) {
                    items.push({
                        num: i + 1,
                        sku: sku,
                        desc: desc,
                        qty: qty,
                        unitPrice: unitPrice.toFixed(2), // Garante 2 casas decimais
                        subTotal: (qty * unitPrice).toFixed(2)
                    });
                }
            }

            if (!poNumber || !poDate || !supplierCnpj) {
                showCustomAlert('Atenção', 'Por favor, preencha o número, a data e selecione o fornecedor.');
                return null;
            }
            if (items.length === 0) {
                showCustomAlert('Atenção', 'O pedido deve ter pelo menos um item válido.');
                return null;
            }

            const poTotalElement = document.getElementById('poTotal').textContent.replace('R$', '').trim().replace('.', '').replace(',', '.');
            const totalValue = parseFloat(poTotalElement);

            return {
                poNumber: poNumber,
                poDate: poDate,
                poDescription: poDescription,
                supplier: supplier,
                items: items,
                totalValue: totalValue.toFixed(2),
                status: status,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Data/Hora da criação/finalização
            };
        }

        // Função para carregar um PO para edição (rascunho ou histórico)
        async function loadOrderForEditing(poNumber, collectionName) {
            try {
                const poDoc = await getUserCollectionRef(collectionName).doc(poNumber).get();
                if (!poDoc.exists) {
                    showCustomAlert('Erro', `Pedido N° ${poNumber} não encontrado.`);
                    return;
                }
                const poData = poDoc.data();

                // 1. Preenche detalhes
                document.getElementById('poNumber').value = poData.poNumber;
                document.getElementById('poDate').value = poData.poDate;
                document.getElementById('poDescription').value = poData.poDescription || '';
                
                // 2. Preenche o Fornecedor e desabilita (se for do histórico)
                await loadSupplierSelect(); // Garante que a lista está carregada
                document.getElementById('supplierSelect').value = poData.supplier.cnpj;
                if (collectionName === 'orders') {
                    document.getElementById('supplierSelect').disabled = true;
                    document.getElementById('poDate').disabled = true;
                    document.getElementById('poDescription').disabled = true;
                }

                // 3. Carrega os itens na tabela
                const itemsBody = document.getElementById('itemsBody');
                itemsBody.innerHTML = ''; // Limpa os itens
                
                // Garante que o catálogo de produtos esteja carregado
                await loadProductSelect(); 
                
                poData.items.forEach(item => {
                    // Garante que os valores venham formatados corretamente para os inputs
                    addItem({
                        sku: item.sku,
                        desc: item.desc,
                        qty: item.qty,
                        unitPrice: item.unitPrice,
                        subTotal: item.subTotal
                    });
                });

                calculateTotal();

                // Desabilita botões se for PO do Histórico (só para visualização)
                if (collectionName === 'orders') {
                    document.querySelector('.btn-draft').style.display = 'none';
                    document.querySelector('.btn-save').style.display = 'none';
                    document.querySelector('.btn-add').style.display = 'none';
                    itemsBody.querySelectorAll('.remove-btn').forEach(btn => btn.style.display = 'none');
                    showCustomAlert('Visualizando', `Visualizando Pedido N° ${poNumber} do Histórico. Edição desabilitada.`);
                }
            } catch (error) {
                console.error("Erro ao carregar PO:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o pedido para edição: ' + error.message);
            }
        }

        // --- Funções de Salvar ---

        async function saveAsDraft() {
            const poData = collectFormData('Rascunho');
            if (!poData) return;

            showCustomConfirm(
                'Confirmação',
                `Deseja salvar o Pedido N° ${poData.poNumber} como rascunho?`,
                async () => {
                    try {
                        await getUserCollectionRef('drafts').doc(poData.poNumber).set(poData);
                        showCustomAlert('Sucesso!', `Rascunho N° ${poData.poNumber} salvo com sucesso!`, () => {
                            window.location.href = 'rascunhos.html';
                        });
                    } catch (error) {
                        console.error("Erro ao salvar rascunho:", error);
                        showCustomAlert('Erro', 'Não foi possível salvar como rascunho: ' + error.message);
                    }
                }
            );
        }

        async function saveAndFinalize() {
            const poData = collectFormData('Finalizado');
            if (!poData) return;

            showCustomConfirm(
                'Confirmação Final',
                `Deseja FINALIZAR e salvar o Pedido N° ${poData.poNumber} no Histórico? Esta ação não pode ser desfeita.`,
                async () => {
                    try {
                        // 1. Tenta salvar na coleção principal ('orders')
                        await getUserCollectionRef('orders').doc(poData.poNumber).set(poData);

                        // 2. Atualiza o contador de POs se for um novo PO
                        const urlParams = new URLSearchParams(window.location.search);
                        if (!urlParams.get('edit_po') && !urlParams.get('edit_draft')) {
                            await updatePoCounter();
                        }
                        
                        // 3. Se for um rascunho sendo finalizado, remove da coleção de rascunhos
                        if (urlParams.get('edit_draft')) {
                             await getUserCollectionRef('drafts').doc(poData.poNumber).delete();
                        }

                        showCustomAlert('Sucesso!', `Pedido N° ${poData.poNumber} finalizado e salvo no Histórico!`, () => {
                            window.location.href = 'historico.html';
                        });
                    } catch (error) {
                        console.error("Erro ao finalizar pedido:", error);
                        showCustomAlert('Erro', 'Não foi possível finalizar o pedido: ' + error.message);
                    }
                }
            );
        }
        
        // --- Função de Inicialização (Chamada após Auth) ---

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const poToEdit = urlParams.get('edit_po');
            const draftToEdit = urlParams.get('edit_draft');

            // Carrega primeiro as listas, pois são necessárias para a interface
            await loadSupplierSelect();
            await loadProductSelect();
            
            // Verifica se está editando ou criando novo
            if (poToEdit) {
                await loadOrderForEditing(poToEdit, 'orders');
            } else if (draftToEdit) {
                await loadOrderForEditing(draftToEdit, 'drafts');
            } else {
                // Novo pedido: Define data e número
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = await getNextPoNumber();
                addItem(); // Adiciona um item inicial vazio
            }
        }

        // Função de carregamento que é chamada após a autenticação
        window.loadData = init;

        window.onload = () => {
            setupModal();
            // CHAMA A FUNÇÃO CORRIGIDA
            setupFirebase(); 
        };

        // Exporta funções para uso global (onchange/onclick no HTML)
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.calculateTotal = calculateTotal;
        window.updateItemDescription = updateItemDescription;
        window.saveAsDraft = saveAsDraft;
        window.saveAndFinalize = saveAndFinalize;
        window.resequenceItems = resequenceItems; 
        window.closeModal = closeModal; // Exporta também para o HTML do modal
    </script>
</body>
</html>
