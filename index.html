<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { text-align: center; margin-bottom: 30px; color: #004c99; }
        .header h1 { font-size: 28px; }
        
        /* Navegação */
        .nav-bar { display: flex; justify-content: space-around; background-color: #004c99; margin-bottom: 20px; border-radius: 4px; }
        .nav-bar a { color: white; padding: 12px 20px; text-decoration: none; font-weight: bold; transition: background-color 0.3s; border-radius: 4px; }
        .nav-bar a:hover, .nav-bar a.active { background-color: #003366; }
        
        /* Estilo do Formulário */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input[type="text"], input[type="date"], input[type="number"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px;
        }
        select { height: 40px; }

        /* Itens do Pedido */
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center; }
        .item-row input, .item-row button { height: 40px; }
        
        /* Botões */
        .action-buttons { margin-top: 25px; text-align: center; }
        .action-buttons button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0 10px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-draft { background-color: #ffc107; color: #333; }
        .btn-draft:hover { background-color: #e0a800; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-save:hover { background-color: #1e7e34; }
        .btn-print { background-color: #007bff; color: white; }
        .btn-print:hover { background-color: #0056b3; }
        .delete-btn { background-color: #dc3545; color: white; padding: 8px 12px; margin-top: 0; }
        .delete-btn:hover { background-color: #c82333; }

        /* Estilos de impressão (Visualização PDF) */
        @media print {
            body { 
                padding: 0; 
                margin: 0;
                background-color: white;
            }
            .container, .nav-bar, .action-buttons {
                display: none;
            }
            .purchase-order {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="index.html" class="active">Criar Pedido</a>
        <a href="fornecedores.html">Cadastrar Fornecedor</a>
        <a href="produtos.html">Cadastrar Produto</a>
        <a href="historico.html">Histórico (Salvos)</a>
        <a href="rascunhos.html">Memorizados (Rascunhos)</a>
    </div>

    <div class="container">
        <div class="header">
            <h1 id="pageTitle">NOVO PEDIDO DE COMPRA</h1>
        </div>
        
        <input type="hidden" id="originalPoNumber"> 

        <div class="form-group">
            <label for="poNumber">Número do Pedido (PO):</label>
            <input type="text" id="poNumber" value="PO-001" readonly>
        </div>
        
        <div class="form-group">
            <label for="poDate">Data do Pedido:</label>
            <input type="date" id="poDate">
        </div>
        
        <hr>
        
        <div class="form-group">
            <label for="supplierSelect">Selecionar Fornecedor:</label>
            <select id="supplierSelect" onchange="loadSupplierData()">
                <option value="">-- Selecione ou Digite Abaixo --</option>
            </select>
        </div>

        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label for="supplierName">Nome do Fornecedor:</label>
                <input type="text" id="supplierName" value="" placeholder="Nome do Fornecedor Ltda.">
            </div>
            <div>
                <label for="supplierContact">Contato/Email:</label>
                <input type="text" id="supplierContact" value="" placeholder="email@fornecedor.com">
            </div>
        </div>
        
        <div class="form-group">
            <label for="deliveryDate">Previsão de Entrega:</label>
            <input type="date" id="deliveryDate">
        </div>

        <hr>

        <label for="items">Itens do Pedido:</label>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="productSelect" style="flex-grow: 1;">
                <option value="">-- Adicionar Produto Cadastrado --</option>
            </select>
            <button onclick="addProductFromSelect()" style="width: 150px; background-color: #007bff;">Adicionar</button>
        </div>
        
        <div id="itemsContainer">
        </div>
        <button onclick="addItem()" style="background-color: #0099cc; width: 100%;">Adicionar Item Manualmente</button>
        
        <div class="form-group" style="margin-top: 20px;">
            <label for="notes">Observações:</label>
            <textarea id="notes" rows="3">Por favor, envie a Nota Fiscal junto com a mercadoria.</textarea>
        </div>
        
        <div class="action-buttons">
            <button class="btn-draft" onclick="saveDraft()">1. Salvar Rascunho / Memorizar</button>
            <button class="btn-save" id="saveButton" onclick="savePurchaseOrder()">2. Salvar Pedido Definitivo (Gravar)</button>
            <button class="btn-print" onclick="printOrder()">3. Visualizar e Imprimir / PDF</button>
        </div>
        
    </div>

    <div class="purchase-order" id="purchaseOrderOutput" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <img 
                src="https://dbrito10.github.io/Farm-cia-do-Trabalhador/Logo.jpg" 
                alt="Logo Farmácia do Trabalhador e Aposentado" 
                style="max-width: 200px; height: auto;" 
            >
            <h1 style="color: #004c99; font-size: 22px; margin: 5px 0 10px 0;">PEDIDO DE COMPRA</h1>
            <div style="font-size: 11px; line-height: 1.5;">
                <p style="margin: 0; font-weight: bold;">FARMÁCIA DO TRABALHADOR E APOSENTADO DE PINHEIROS LTDA | CNPJ: 32.927.077/0001-06</p>
                <p style="margin: 0;">Endereço: PRAÇA BAIANA 75-B ANEXO B, Centro, Pinheiros/ES, CEP 29980-000</p>
                <p style="margin: 0;">Telefone: (27) 99981-8349</p>
            </div>
            <hr style="border: 1px solid #004c99; margin-top: 10px;">
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px;">
            <div style="font-weight: bold;">
                Pedido N°: <span id="outPoNumber">PO-001</span>
            </div>
            <div>
                Data: <span id="outPoDate">2025-10-05</span>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; font-size: 12px;">
            <div>
                <p style="font-weight: bold; color: #004c99; margin: 0 0 5px 0;">DADOS DO FORNECEDOR</p>
                <div>**Fornecedor:** <span id="outSupplierName"></span></div>
                <div>**Contato:** <span id="outSupplierContact"></span></div>
            </div>
            <div style="text-align: right;">
                <p style="font-weight: bold; color: #004c99; margin: 0 0 5px 0;">DETALHES DA ENTREGA</p>
                <div>**Previsão:** <span id="outDeliveryDate"></span></div>
                <div>**Local:** PRAÇA BAIANA 75-B ANEXO B</div>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #333; padding: 8px; text-align: left; background-color: #f2f2f2; width: 45%;">Item / Descrição</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 10%;">SKU</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 10%;">Qtd.</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; width: 15%;">Preço Unit. (R$)</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; width: 20%;">Total (R$)</th>
                </tr>
            </thead>
            <tbody id="poTableBody">
            </tbody>
        </table>

        <div style="margin-top: 20px; text-align: right; font-size: 13px;">
            <div>Subtotal: <span id="outSubtotal" style="font-weight: bold;">R$ 0,00</span></div>
            <div style="margin-top: 5px; font-size: 16px; border-top: 1px solid #ccc; padding-top: 5px;">
                **TOTAL GERAL:** <span id="outTotal" style="color: #dc3545;">R$ 0,00</span>
            </div>
        </div>

        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; font-size: 12px;">
            <p style="font-weight: bold; color: #004c99; margin: 0 0 5px 0;">OBSERVAÇÕES:</p>
            <p id="outNotes" style="margin: 0;">Por favor, envie a Nota Fiscal junto com a mercadoria.</p>
        </div>
        
        <div style="margin-top: 40px; text-align: center; font-size: 10px;">
            <hr style="width: 50%; margin: 40px auto 5px auto;">
            <p>Assinatura / Carimbo - FARMÁCIA DO TRABALHADOR E APOSENTADO</p>
        </div>
    </div>
    
    <script>
        let items = [];
        let itemIndexCounter = 0; 

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // --- FUNÇÕES DE CADASTRO DE DADOS ---

        function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">-- Selecione ou Digite Abaixo --</option>';
            const suppliers = JSON.parse(localStorage.getItem('suppliers')) || {};
            
            Object.keys(suppliers).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }
        
        function loadSupplierData() {
            const selectedName = document.getElementById('supplierSelect').value;
            if (!selectedName) return;

            const suppliers = JSON.parse(localStorage.getItem('suppliers'));
            const supplier = suppliers[selectedName];

            if (supplier) {
                document.getElementById('supplierName').value = supplier.name || '';
                document.getElementById('supplierContact').value = supplier.contact || '';
            }
        }
        
        function loadProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">-- Adicionar Produto Cadastrado --</option>';
            const products = JSON.parse(localStorage.getItem('products')) || {};
            
            Object.keys(products).forEach(key => {
                const product = products[key];
                const option = document.createElement('option');
                option.value = product.sku;
                option.textContent = `(${product.sku}) ${product.desc} - R$ ${product.price.replace('.', ',')}`;
                select.appendChild(option);
            });
        }
        
        function addProductFromSelect() {
            const selectedSku = document.getElementById('productSelect').value;
            if (!selectedSku) {
                alert("Por favor, selecione um produto do catálogo.");
                return;
            }
            
            const products = JSON.parse(localStorage.getItem('products'));
            const product = products[selectedSku];
            
            if (product) {
                addItem(product.desc, product.sku, 1, product.price);
            }
            document.getElementById('productSelect').value = "";
        }

        function addItem(desc = '', sku = '', qty = 1, price = 0.00) {
            const container = document.getElementById('itemsContainer');
            const newIndex = itemIndexCounter++;
            
            const itemRow = document.createElement('div');
            itemRow.classList.add('item-row');
            itemRow.id = `row-${newIndex}`;
            itemRow.innerHTML = `
                <input type="text" id="desc-${newIndex}" value="${desc}" placeholder="Descrição do Item">
                <input type="text" id="sku-${newIndex}" value="${sku}" placeholder="SKU/Cód.">
                <input type="number" id="qty-${newIndex}" value="${qty}" min="1">
                <input type="number" id="price-${newIndex}" value="${parseFloat(price).toFixed(2)}" min="0" step="0.01">
                <button class="delete-btn" onclick="removeItem(${newIndex})">X</button>
            `;
            container.appendChild(itemRow);
            
            items.push({ index: newIndex }); 
        }

        function removeItem(index) {
            const element = document.getElementById(`row-${index}`);
            if (element) {
                element.remove();
                items = items.filter(item => item.index !== index);
            }
        }
        
        // --- FUNÇÕES DE VISUALIZAÇÃO/IMPRESSÃO ---

        function updateDraft() {
            // Esta função preenche a estrutura do PDF/impressão
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierName = document.getElementById('supplierName').value;
            const supplierContact = document.getElementById('supplierContact').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value;

            document.getElementById('outPoNumber').textContent = poNumber || 'N/A';
            document.getElementById('outPoDate').textContent = poDate ? formatDate(poDate) : 'N/A';
            document.getElementById('outSupplierName').textContent = supplierName || 'N/A';
            document.getElementById('outSupplierContact').textContent = supplierContact || 'N/A';
            document.getElementById('outDeliveryDate').textContent = deliveryDate ? formatDate(deliveryDate) : 'N/A';
            document.getElementById('outNotes').textContent = notes || 'Nenhuma observação.';
            
            let total = 0;
            const poTableBody = document.getElementById('poTableBody');
            poTableBody.innerHTML = ''; 

            items = items.filter(item => document.getElementById(`desc-${item.index}`)); 

            items.forEach(item => {
                const index = item.index;
                const desc = document.getElementById(`desc-${index}`)?.value || '';
                const sku = document.getElementById(`sku-${index}`)?.value || '';
                const qty = parseFloat(document.getElementById(`qty-${index}`)?.value) || 0;
                const price = parseFloat(document.getElementById(`price-${index}`)?.value) || 0;
                
                if (!desc) return; 
                
                const itemTotal = qty * price;
                total += itemTotal;
                
                const newRow = poTableBody.insertRow();
                newRow.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">**${desc}**</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${sku || 'N/A'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${qty.toLocaleString('pt-BR')}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">R$ ${price.toFixed(2).replace('.', ',')}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">R$ ${itemTotal.toFixed(2).replace('.', ',')}</td>
                `;
            });
            
            document.getElementById('outSubtotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('outTotal').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }
        
        function printOrder() {
            if (items.filter(item => document.getElementById(`desc-${item.index}`)?.value).length === 0) {
                alert("Adicione pelo menos um item ao pedido antes de visualizar/imprimir.");
                return;
            }
            updateDraft(); 
            window.print();
        }

        // --- FUNÇÕES DE AÇÃO (SALVAR E RASCUNHO) ---

        function getCurrentOrderData() {
            const orderItems = [];
            items.forEach(item => {
                const index = item.index;
                const descInput = document.getElementById(`desc-${index}`);
                if (descInput && descInput.value.trim()) {
                    orderItems.push({
                        desc: descInput.value,
                        sku: document.getElementById(`sku-${index}`).value,
                        qty: document.getElementById(`qty-${index}`).value,
                        price: document.getElementById(`price-${index}`).value
                    });
                }
            });

            return {
                poNumber: document.getElementById('poNumber').value,
                poDate: document.getElementById('poDate').value,
                supplierName: document.getElementById('supplierName').value,
                supplierContact: document.getElementById('supplierContact').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                notes: document.getElementById('notes').value,
                items: orderItems
            };
        }

        // 1. Salvar Rascunho / Memorizar
        function saveDraft() {
            const poNumber = document.getElementById('poNumber').value;
            
            if (items.filter(item => document.getElementById(`desc-${item.index}`)?.value).length === 0) {
                alert("Adicione pelo menos um item ao pedido para salvar como rascunho.");
                return;
            }
            
            const orderData = getCurrentOrderData();
            let memorizedOrders = JSON.parse(localStorage.getItem('memorizedOrders')) || {};
            
            if (memorizedOrders[poNumber] && !document.getElementById('originalPoNumber').value) {
                if (!confirm(`O Rascunho N° ${poNumber} já existe. Deseja sobrescrevê-lo?`)) {
                    return;
                }
            }
            
            // Salva na chave de rascunhos
            memorizedOrders[poNumber] = orderData;
            localStorage.setItem('memorizedOrders', JSON.stringify(memorizedOrders));
            
            alert(`Rascunho do Pedido N° ${poNumber} foi salvo com sucesso!`);
            
            // Recarrega para limpar o modo de edição
            window.location.href = 'index.html'; 
        }


        // 2. Salvar Pedido Definitivo (Gravação)
        function savePurchaseOrder() {
            const poNumber = document.getElementById('poNumber').value;
            const originalPoNumber = document.getElementById('originalPoNumber').value;

            if (!poNumber || poNumber.trim() === '') {
                alert("O número do pedido (PO) é obrigatório para salvar!");
                return;
            }
            if (items.filter(item => document.getElementById(`desc-${item.index}`)?.value).length === 0) {
                 alert("Adicione pelo menos um item ao pedido antes de salvar.");
                return;
            }

            const orderData = getCurrentOrderData();
            let savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || {};
            
            // Lógica de Edição: Se o PONumber foi alterado e havia um PO original, exclui o original
            if (originalPoNumber && originalPoNumber !== poNumber && savedOrders[originalPoNumber]) {
                 delete savedOrders[originalPoNumber];
            }
            
            // Lógica de Sobrescrita:
            if (savedOrders[poNumber] && !originalPoNumber && !confirm(`O Pedido N° ${poNumber} já existe. Deseja sobrescrevê-lo?`)) {
                return;
            }
            
            savedOrders[poNumber] = orderData;
            localStorage.setItem('savedOrders', JSON.stringify(savedOrders));
            
            // Remove o rascunho correspondente se existir
            let memorizedOrders = JSON.parse(localStorage.getItem('memorizedOrders')) || {};
            if(memorizedOrders[poNumber]) {
                delete memorizedOrders[poNumber];
                localStorage.setItem('memorizedOrders', JSON.stringify(memorizedOrders));
            }

            alert(`Pedido N° ${poNumber} salvo/atualizado com sucesso! Você será redirecionado para o Histórico.`);
            
            window.location.href = 'historico.html';
        }
        
        // --- FUNÇÃO DE CARREGAMENTO PARA EDIÇÃO/RASCUNHO ---

        function loadOrderForEditing(poNumber, sourceKey) {
            const orders = JSON.parse(localStorage.getItem(sourceKey)) || {};
            const orderData = orders[poNumber];
            
            if (!orderData) {
                alert(`Erro: Pedido de compra N° ${poNumber} não encontrado na fonte ${sourceKey}.`);
                return;
            }
            
            // 1. Preenche os campos principais
            document.getElementById('originalPoNumber').value = poNumber; // Guarda o PO original
            document.getElementById('poNumber').value = orderData.poNumber;
            document.getElementById('poDate').value = orderData.poDate;
            document.getElementById('supplierName').value = orderData.supplierName;
            document.getElementById('supplierContact').value = orderData.supplierContact;
            document.getElementById('deliveryDate').value = orderData.deliveryDate;
            document.getElementById('notes').value = orderData.notes;
            
            // Atualiza o título e o botão
            document.getElementById('pageTitle').textContent = (sourceKey === 'savedOrders' ? 'EDITANDO PEDIDO SALVO N° ' : 'EDITANDO RASCUNHO N° ') + poNumber;
            document.getElementById('saveButton').textContent = '2. Atualizar Pedido (Gravar)';
            
            // 2. Limpa e recarrega os itens
            document.getElementById('itemsContainer').innerHTML = '';
            items = []; 
            itemIndexCounter = 0;
            
            orderData.items.forEach(item => {
                addItem(item.desc, item.sku, item.qty, item.price);
            });

            // 3. Tenta selecionar o fornecedor no select (se o nome coincidir)
            const select = document.getElementById('supplierSelect');
            select.value = orderData.supplierName;
        }

        function getNextPoNumber() {
            const savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || {};
            const memorizedOrders = JSON.parse(localStorage.getItem('memorizedOrders')) || {};
            
            const allKeys = [...Object.keys(savedOrders), ...Object.keys(memorizedOrders)];
            
            let lastNumber = 0;
            allKeys.forEach(key => {
                const match = key.match(/PO-(\d+)/);
                if (match) {
                    const number = parseInt(match[1]);
                    if (number > lastNumber) {
                        lastNumber = number;
                    }
                }
            });
            return `PO-${(lastNumber + 1).toString().padStart(3, '0')}`;
        }
        
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const poToEdit = urlParams.get('edit_po');
            const draftToEdit = urlParams.get('edit_draft');

            loadSupplierSelect();
            loadProductSelect();
            
            if (poToEdit) {
                loadOrderForEditing(poToEdit, 'savedOrders');
            } else if (draftToEdit) {
                loadOrderForEditing(draftToEdit, 'memorizedOrders');
            } else {
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = getNextPoNumber();
                addItem(); 
            }
        }

        window.onload = init;
    </script>
</body>
</html>
