<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        
        /* Barra Superior (User/Logout) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .user-info { font-weight: bold; color: #004c99; font-size: 14px; }
        .logout-btn { background-color: #004c99; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #003666; }

        /* Estilos Formulário */
        h1 { color: #004c99; text-align: center; margin-bottom: 20px; }
        h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .header-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .header-info .po-number { grid-column: 2 / 3; } /* Alinha o número do PO à direita */
        
        /* Tabela de Itens */
        .items-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .items-table th, .items-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .items-table th { background-color: #f0f0f0; color: #333; font-weight: 700; }
        .items-table td input, .items-table td select { width: 95%; box-sizing: border-box; border: 1px solid #ddd; padding: 6px; border-radius: 3px; }
        .items-table td.qty-cell, .items-table td.price-cell, .items-table td.total-cell, .items-table td.action-cell { width: 100px; text-align: center; }
        .items-table td.desc-cell { width: 40%; }
        .total-row td { font-weight: bold; background-color: #e6f0ff; }

        /* Botões */
        .action-buttons { text-align: center; margin-top: 30px; }
        .btn { padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; margin: 0 10px; font-weight: bold; transition: background-color 0.3s; }
        .btn-save-draft { background-color: #f39c12; color: white; }
        .btn-save-draft:hover { background-color: #e67e22; }
        .btn-finalize { background-color: #2ecc71; color: white; }
        .btn-finalize:hover { background-color: #27ae60; }
        .btn-add-item { background-color: #3498db; color: white; margin-bottom: 15px; float: right; }
        .btn-add-item:hover { background-color: #2980b9; }
        .btn-remove-item { background-color: #e74c3c; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-remove-item:hover { background-color: #c0392b; }

        /* Modal e Alertas Customizados (Reutilizados em todos os arquivos) */
        .modal, .custom-alert-overlay, .custom-confirm-overlay {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content, .custom-alert-box, .custom-confirm-box {
            background-color: #fefefe; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            max-width: 90%; max-height: 90%; overflow: auto; animation: fadeIn 0.3s;
        }
        .custom-alert-box, .custom-confirm-box { width: 300px; text-align: center; }
        .custom-alert-box button, .custom-confirm-box button { margin-top: 15px; padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; }
        .custom-confirm-buttons button { margin: 0 10px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-close { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-close:hover, .modal-close:focus { color: #333; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <span class="user-info" id="userInfo">Carregando usuário...</span>
            <div>
                <a href="fornecedores.html" class="btn logout-btn" style="margin-right: 10px;">Fornecedores</a>
                <a href="produtos.html" class="btn logout-btn" style="margin-right: 10px;">Produtos</a>
                <a href="rascunhos.html" class="btn logout-btn" style="margin-right: 10px;">Rascunhos</a>
                <a href="historico.html" class="btn logout-btn" style="margin-right: 10px;">Histórico</a>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>
        
        <h1>Gerador de Pedido de Compra</h1>

        <form id="purchaseOrderForm">
            <div class="header-info">
                <div class="form-group">
                    <label for="supplierSelect">Fornecedor</label>
                    <select id="supplierSelect" required>
                        <option value="">Selecione um Fornecedor</option>
                    </select>
                </div>
                <div class="form-group po-number">
                    <label for="poNumber">Nº do Pedido</label>
                    <input type="text" id="poNumber" name="poNumber" readonly style="background-color: #f0f0f0; font-weight: bold;">
                </div>
                <div class="form-group">
                    <label for="poDate">Data do Pedido</label>
                    <input type="date" id="poDate" name="poDate" required>
                </div>
                <div class="form-group">
                    <label for="poPayment">Condição de Pagamento</label>
                    <input type="text" id="poPayment" name="poPayment" value="30 dias" required>
                </div>
            </div>

            <h2>Itens do Pedido <button type="button" class="btn-add-item" onclick="addItem()">+ Adicionar Item</button></h2>
            
            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Seq</th>
                        <th style="width: 40%;">Produto / Descrição</th>
                        <th style="width: 15%;">SKU / Código</th>
                        <th style="width: 10%;">Qtd</th>
                        <th style="width: 15%;">Preço Unit.</th>
                        <th style="width: 10%;">Total</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="itemsContainer">
                    <!-- Itens serão adicionados aqui via JavaScript -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5" style="text-align: right;">Total Geral:</td>
                        <td id="grandTotal" style="text-align: center;">R$ 0,00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            
            <div class="form-group" style="margin-top: 30px;">
                <label for="poNotes">Observações</label>
                <textarea id="poNotes" name="poNotes" rows="4" placeholder="Adicione notas, instruções de entrega ou informações fiscais aqui."></textarea>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn btn-save-draft" onclick="saveAsDraft()">Salvar Rascunho</button>
                <button type="submit" class="btn btn-finalize">Finalizar Pedido de Compra</button>
            </div>
        </form>

    </div>

    <!-- Modal para Alertas e Confirmações Personalizadas -->
    <div id="customAlertOverlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <h3 id="customAlertTitle"></h3>
            <p id="customAlertMessage"></p>
            <button onclick="closeModal('customAlertOverlay')">OK</button>
        </div>
    </div>
    
    <div id="customConfirmOverlay" class="custom-confirm-overlay">
        <div class="custom-confirm-box">
            <h3 id="customConfirmTitle"></h3>
            <p id="customConfirmMessage"></p>
            <div class="custom-confirm-buttons">
                <button id="confirmYesBtn">Sim</button>
                <button id="confirmNoBtn" onclick="closeModal('customConfirmOverlay')">Não</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais (padronizadas em todos os arquivos)
        let auth, db, userId;
        const poKey = 'poNumber'; // Chave usada para o número do pedido

        // Configuração do Firebase (A mesma do login.html)
        const firebaseConfig = {
          apiKey: "AIzaSyAXKlq9WOs_5_ilfhG13xQwNVwQa6MaBfg",
          authDomain: "farmacia-a6682.firebaseapp.com",
          projectId: "farmacia-a6682",
          storageBucket: "farmacia-a6682.firebasestorage.app",
          messagingSenderId: "144965717217",
          appId: "1:144965717217:web:de43b2316e8b7a25293ba0"
        };
        
        // --- INICIALIZAÇÃO E AUTENTICAÇÃO PADRONIZADA ---
        function setupFirebase() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();

            // Listener de autenticação para garantir que o usuário está logado
            auth.onAuthStateChanged(user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userInfo').textContent = `Usuário: ${user.email}`;
                    // Chama a função principal de carregamento após a autenticação
                    window.loadData();
                } else {
                    // Se não estiver logado, redireciona para a tela de login
                    window.location.href = 'login.html';
                }
            });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        /**
         * FUNÇÃO CRÍTICA PARA OBTER A REFERÊNCIA DA COLEÇÃO DO USUÁRIO.
         * Caminho: users/{userId}/[collectionName]
         */
        function getUserCollectionRef(collectionName) {
            if (!db || !userId) {
                throw new Error("Firebase não inicializado ou usuário não logado.");
            }
            // CORREÇÃO DE CAMINHO: Usando a estrutura users/{userId}/collectionName
            return db.collection('users').doc(userId).collection(collectionName);
        }

        // --- FUNÇÕES DE UTENSÍLIO DE UI (MODAL/ALERTS) ---
        function setupModal() {
            window.showCustomAlert = (title, message, callback) => {
                document.getElementById('customAlertTitle').textContent = title;
                document.getElementById('customAlertMessage').textContent = message;
                document.getElementById('customAlertOverlay').style.display = 'flex';
                document.getElementById('customAlertOverlay').onclick = (e) => {
                    if (e.target.id === 'customAlertOverlay' || e.target.tagName === 'BUTTON') {
                        closeModal('customAlertOverlay');
                        if (callback) callback();
                    }
                };
            };

            window.showCustomConfirm = (title, message, onYes) => {
                document.getElementById('customConfirmTitle').textContent = title;
                document.getElementById('customConfirmMessage').textContent = message;
                document.getElementById('customConfirmOverlay').style.display = 'flex';
                
                const yesBtn = document.getElementById('confirmYesBtn');
                yesBtn.onclick = () => {
                    closeModal('customConfirmOverlay');
                    onYes();
                };
            };
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- FUNÇÕES CORE DO SISTEMA ---

        let itemSequence = 0;
        let productsCache = []; // Cache para evitar múltiplas leituras

        /**
         * NOVO CÓDIGO CRÍTICO: Geração de Número Sequencial com TRANSAÇÃO ATÔMICA
         * Garante que dois usuários ou duas abas não gerem o mesmo número.
         */
        async function getNextPoNumber() {
            // Referência para o documento de contador (privado para o usuário)
            const counterRef = getUserCollectionRef('meta').doc('poNumberCounter');

            try {
                // Inicia a transação
                const newPoNumber = await db.runTransaction(async (transaction) => {
                    // 1. LÊ o documento do contador
                    const counterDoc = await transaction.get(counterRef);
                    
                    let currentNumber = 0; // Começa em 0 para a primeira vez
                    if (counterDoc.exists && counterDoc.data() && typeof counterDoc.data().currentNumber === 'number') {
                        currentNumber = counterDoc.data().currentNumber;
                    }

                    const nextNumber = currentNumber + 1;

                    // 2. ESCREVE o novo valor incrementado de volta (ação atômica)
                    transaction.set(counterRef, { currentNumber: nextNumber });
                    
                    return nextNumber; // 3. Retorna o novo número
                });

                // Formata o número (ex: 1 -> 0001, 12 -> 0012)
                return newPoNumber.toString().padStart(4, '0'); 
                
            } catch (error) {
                console.error("Erro ao gerar número sequencial (Transação falhou):", error);
                showCustomAlert('Erro Crítico', 'Não foi possível gerar um número sequencial único para o pedido. Verifique as regras do Firestore ou o console.');
                return 'ERRO-0000'; 
            }
        }
        
        async function loadSupplierSelect() {
            try {
                const suppliersRef = getUserCollectionRef('suppliers'); // CORRIGIDO PARA O CAMINHO PRIVADO
                const snapshot = await suppliersRef.get();
                const select = document.getElementById('supplierSelect');
                select.innerHTML = '<option value="">Selecione um Fornecedor</option>';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id; // Usa o CNPJ como valor
                    option.textContent = `${data.name} (${doc.id})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar fornecedores:", error);
                showCustomAlert('Erro', 'Não foi possível carregar a lista de fornecedores. Verifique se foram cadastrados e se as regras do Firestore estão corretas.');
            }
        }

        async function loadProductSelect() {
            try {
                const productsRef = getUserCollectionRef('products'); // CORRIGIDO PARA O CAMINHO PRIVADO
                const snapshot = await productsRef.get();
                const select = document.createElement('select'); // Cria um select temporário
                productsCache = []; // Limpa o cache
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    productsCache.push({ id: doc.id, ...data }); // Salva no cache
                    
                    const option = document.createElement('option');
                    option.value = doc.id; // Usa o SKU como valor
                    option.textContent = `${data.name} (R$ ${parseFloat(data.price).toFixed(2).replace('.', ',')})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o catálogo de produtos. Verifique se foram cadastrados e se as regras do Firestore estão corretas.');
            }
        }
        
        function updateItemDescription(selectElement) {
            const row = selectElement.closest('tr');
            const sku = selectElement.value;
            const descInput = row.querySelector('.desc-input');
            const skuInput = row.querySelector('.sku-input');
            const priceInput = row.querySelector('.price-input');
            
            const product = productsCache.find(p => p.id === sku);

            if (product) {
                descInput.value = product.desc;
                skuInput.value = product.id;
                priceInput.value = parseFloat(product.price || 0).toFixed(2);
            } else {
                // Limpa se a opção "Selecione" for escolhida
                descInput.value = '';
                skuInput.value = sku; // Mantém o SKU se for digitado manualmente
                priceInput.value = '0.00';
            }
            calculateTotal(row.querySelector('.qty-input')); // Recalcula a linha
        }
        
        function addItem(productData = {}) {
            itemSequence++;
            const container = document.getElementById('itemsContainer');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-sequence', itemSequence);
            newRow.innerHTML = `
                <td class="seq-cell">${itemSequence}</td>
                <td class="desc-cell">
                    <select class="product-select" onchange="updateItemDescription(this)">
                        <option value="">Selecione um Produto</option>
                        ${productsCache.map(p => 
                            `<option value="${p.id}" ${productData.sku === p.id ? 'selected' : ''}>${p.name} (R$ ${parseFloat(p.price).toFixed(2).replace('.', ',')})</option>`
                        ).join('')}
                    </select>
                    <input type="text" class="desc-input" placeholder="Descrição detalhada" value="${productData.desc || ''}" required>
                </td>
                <td class="sku-cell">
                    <input type="text" class="sku-input" placeholder="SKU" value="${productData.sku || ''}">
                </td>
                <td class="qty-cell">
                    <input type="number" min="1" class="qty-input" value="${productData.qty || 1}" 
                        oninput="calculateTotal(this)" required>
                </td>
                <td class="price-cell">
                    <input type="number" step="0.01" class="price-input" value="${(productData.price || 0).toFixed(2)}"
                        oninput="calculateTotal(this)" required>
                </td>
                <td class="total-cell line-total">R$ 0,00</td>
                <td class="action-cell">
                    <button type="button" class="btn-remove-item" onclick="removeItem(this)">X</button>
                </td>
            `;
            container.appendChild(newRow);

            // Recalcula o total da linha se estiver carregando dados existentes
            if (productData.qty || productData.price) {
                 calculateTotal(newRow.querySelector('.qty-input'));
            }

            // Atualiza o total geral
            updateGrandTotal();
        }

        function removeItem(button) {
            const row = button.closest('tr');
            row.remove();
            resequenceItems();
            updateGrandTotal();
        }

        function resequenceItems() {
            const rows = document.querySelectorAll('#itemsContainer tr');
            itemSequence = 0;
            rows.forEach((row, index) => {
                const seqCell = row.querySelector('.seq-cell');
                itemSequence = index + 1;
                row.setAttribute('data-sequence', itemSequence);
                if (seqCell) seqCell.textContent = itemSequence;
            });
        }
        
        function calculateTotal(inputElement) {
            const row = inputElement.closest('tr');
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const lineTotal = qty * price;

            row.querySelector('.line-total').textContent = `R$ ${lineTotal.toFixed(2).replace('.', ',')}`;
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('#itemsContainer tr').forEach(row => {
                const lineTotalText = row.querySelector('.line-total').textContent.replace('R$ ', '').replace(',', '.');
                grandTotal += parseFloat(lineTotalText) || 0;
            });
            document.getElementById('grandTotal').textContent = `R$ ${grandTotal.toFixed(2).replace('.', ',')}`;
        }

        function getFormData() {
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierId = document.getElementById('supplierSelect').value;
            const supplierName = document.getElementById('supplierSelect').options[document.getElementById('supplierSelect').selectedIndex].text.split('(')[0].trim();
            const poPayment = document.getElementById('poPayment').value;
            const poNotes = document.getElementById('poNotes').value;
            const grandTotalText = document.getElementById('grandTotal').textContent.replace('R$ ', '').replace(',', '.');
            const grandTotal = parseFloat(grandTotalText) || 0;

            const items = [];
            document.querySelectorAll('#itemsContainer tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const lineTotal = qty * price;

                items.push({
                    seq: parseInt(row.getAttribute('data-sequence')),
                    productName: row.querySelector('.product-select').options[row.querySelector('.product-select').selectedIndex].text.split('(')[0].trim(),
                    sku: row.querySelector('.sku-input').value.trim(),
                    desc: row.querySelector('.desc-input').value.trim(),
                    qty: qty,
                    price: price,
                    total: lineTotal
                });
            });

            return {
                poNumber: poNumber,
                poDate: poDate,
                supplierId: supplierId,
                supplierName: supplierName,
                poPayment: poPayment,
                poNotes: poNotes,
                grandTotal: grandTotal,
                items: items,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // Para registro de data
            };
        }

        // --- SALVAR RASCUNHO/FINALIZAR (Com correção de caminho) ---
        async function saveOrder(collectionName, data) {
            if (data.poNumber === 'ERRO-0000') {
                 showCustomAlert('Atenção', 'Não foi possível salvar devido a um erro na geração do número do pedido.');
                 return false;
            }

            try {
                // Usa o número do PO como ID do documento
                const docRef = getUserCollectionRef(collectionName).doc(data.poNumber);
                await docRef.set(data); 
                return true;
            } catch (error) {
                console.error(`Erro ao salvar pedido na coleção ${collectionName}:`, error);
                showCustomAlert('Erro Crítico de Salvar', `Não foi possível salvar. Verifique o caminho da coleção (users/{uid}/${collectionName}) e as Regras de Segurança.`);
                return false;
            }
        }

        async function saveAsDraft() {
            const data = getFormData();
            if (await saveOrder('drafts', data)) { // Usa a coleção 'drafts'
                showCustomAlert('Rascunho Salvo!', `O Pedido N° ${data.poNumber} foi salvo como rascunho.`, () => {
                    window.location.href = 'rascunhos.html';
                });
            }
        }
        
        async function saveAndFinalize(event) {
            event.preventDefault();

            const data = getFormData();
            // Validação simples
            if (!data.supplierId || data.items.length === 0 || data.items.some(item => item.qty <= 0 || item.price <= 0)) {
                showCustomAlert('Validação', 'Preencha o fornecedor e adicione pelo menos um item com quantidade e preço válidos.');
                return;
            }

            // O número do PO já foi gerado (ou erro) na inicialização.
            if (await saveOrder('orders', data)) { // Usa a coleção 'orders' (Histórico)
                showCustomAlert('Pedido Finalizado!', `O Pedido N° ${data.poNumber} foi salvo no Histórico.`, () => {
                    window.location.href = 'historico.html';
                });
            }
        }

        // --- CARREGAMENTO PARA EDIÇÃO (se vier dos rascunhos ou histórico) ---
        async function loadOrderForEditing(poNumber, collectionName) {
            try {
                const docRef = getUserCollectionRef(collectionName).doc(poNumber);
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const data = docSnap.data();

                    document.getElementById('poNumber').value = data.poNumber;
                    document.getElementById('poDate').value = data.poDate;
                    document.getElementById('poPayment').value = data.poPayment;
                    document.getElementById('poNotes').value = data.poNotes || '';
                    
                    // Seleciona o fornecedor
                    const supplierSelect = document.getElementById('supplierSelect');
                    if (data.supplierId) {
                        supplierSelect.value = data.supplierId;
                    }

                    // Carrega os itens
                    document.getElementById('itemsContainer').innerHTML = '';
                    itemSequence = 0;
                    data.items.sort((a, b) => a.seq - b.seq).forEach(item => {
                        addItem(item);
                    });
                    
                    updateGrandTotal();
                } else {
                    showCustomAlert('Erro', 'Pedido não encontrado!');
                }
            } catch (error) {
                console.error("Erro ao carregar pedido para edição:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o pedido. Verifique o console.');
            }
        }

        // --- INICIALIZAÇÃO DA PÁGINA ---
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const poToEdit = urlParams.get('po'); // Se veio do Histórico
            const draftToEdit = urlParams.get('draft'); // Se veio dos Rascunhos

            // Carrega primeiro as listas, pois são necessárias para a interface
            await loadSupplierSelect();
            await loadProductSelect();
            
            // Verifica se está editando ou criando novo
            if (poToEdit) {
                await loadOrderForEditing(poToEdit, 'orders');
            } else if (draftToEdit) {
                await loadOrderForEditing(draftToEdit, 'drafts');
            } else {
                // Novo pedido: Define data e número
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = await getNextPoNumber();
                addItem(); // Adiciona um item inicial vazio
            }
        }

        // Função de carregamento que é chamada após a autenticação
        window.loadData = init;

        window.onload = () => {
            setupModal();
            // CHAMA A FUNÇÃO CORRIGIDA
            setupFirebase(); 
            document.getElementById('purchaseOrderForm').addEventListener('submit', saveAndFinalize);
        };

        // Exporta funções para uso global (onchange/onclick no HTML)
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.calculateTotal = calculateTotal;
        window.updateItemDescription = updateItemDescription;
        window.saveAsDraft = saveAsDraft;
        window.saveAndFinalize = saveAndFinalize;
        window.resequenceItems = resequenceItems; 
        window.closeModal = closeModal; 
        window.logout = logout;
    </script>
</body>
</html>
