<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    
    <!-- Importações do Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        
        /* Barra Superior (User/Logout) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .user-info { font-weight: bold; color: #004c99; font-size: 14px; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c82333; }
        
        /* Cabeçalho */
        h1 { color: #004c99; margin-top: 0; border-bottom: 2px solid #004c99; padding-bottom: 10px; }
        
        /* Menu de Navegação */
        .nav-menu {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .nav-menu a {
            text-decoration: none;
            color: #004c99;
            padding: 8px 15px;
            margin-right: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        .nav-menu a:hover {
            background-color: #e9ecef;
        }
        .nav-menu .active {
            background-color: #004c99;
            color: white;
        }
        
        /* Formulário */
        .form-section { margin-bottom: 25px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; }
        .form-header { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* Tabela de Itens */
        .items-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
        .items-table th { background-color: #f8f9fa; color: #333; }
        .items-table td input, .items-table td select { padding: 6px; border: 1px solid #ddd; border-radius: 3px; width: 100%; box-sizing: border-box; }
        .items-table .item-total { text-align: right; font-weight: bold; }
        .items-table .action-col { width: 50px; text-align: center; }
        
        /* Totais */
        .totals-section { text-align: right; margin-top: 20px; padding-top: 10px; border-top: 2px solid #004c99; }
        .totals-section p { font-size: 18px; font-weight: bold; color: #004c99; }

        /* Ações */
        .actions-section { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        .actions-section button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .btn-draft { background-color: #ffc107; color: #212529; }
        .btn-draft:hover { background-color: #e0a800; }
        .btn-finalize { background-color: #28a745; color: white; }
        .btn-finalize:hover { background-color: #1e7e34; }
        .btn-add-item { background-color: #007bff; color: white; margin-top: 10px; }
        .btn-add-item:hover { background-color: #0056b3; }
        .btn-remove-item { background-color: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; }

        /* Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        
        /* Estilos do Modal de Confirmação/Alerta (Customizado) */
        #customModal { z-index: 20; }
        .modal-message { margin-bottom: 20px; font-size: 16px; text-align: center; }
        .modal-actions { display: flex; justify-content: space-around; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .modal-actions .confirm-yes { background-color: #28a745; color: white; }
        .modal-actions .confirm-no { background-color: #6c757d; color: white; }
        .modal-actions .alert-ok { background-color: #007bff; color: white; width: 100%; }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="top-bar">
            <div class="user-info" id="userInfo">Aguardando autenticação...</div>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="active">Pedido de Compra</a>
            <a href="rascunhos.html">Rascunhos</a>
            <a href="historico.html">Histórico</a>
            <a href="produtos.html">Catálogo de Produtos</a>
            <a href="fornecedores.html">Catálogo de Fornecedores</a>
        </div>

        <h1>Novo Pedido de Compra (P.O.)</h1>
        
        <form id="purchaseOrderForm">
            <div class="form-section">
                <h3>Dados do Pedido</h3>
                <div class="form-header">
                    <div class="form-group" style="flex: 2;">
                        <label for="supplierSelect">Fornecedor</label>
                        <select id="supplierSelect" name="supplierSelect" required>
                            <option value="">Selecione um Fornecedor...</option>
                            <!-- Lista de fornecedores injetada via JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="poNumber">N° do Pedido</label>
                        <input type="text" id="poNumber" name="poNumber" readonly>
                    </div>
                    <div class="form-group">
                        <label for="poDate">Data</label>
                        <input type="date" id="poDate" name="poDate" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Itens do Pedido</h3>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 15%;">SKU</th>
                            <th style="width: 35%;">Produto / Descrição</th>
                            <th style="width: 10%;">Qtd</th>
                            <th style="width: 15%;">Preço Unitário</th>
                            <th style="width: 15%; text-align: right;">Total Item</th>
                            <th class="action-col">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- Linhas de itens injetadas via JS -->
                    </tbody>
                </table>
                
                <button type="button" class="btn-add-item" onclick="addItem()">+ Adicionar Item</button>
            </div>
            
            <div class="form-section">
                <h3>Observações</h3>
                <div class="form-group">
                    <textarea id="notes" name="notes" rows="3" style="width: 100%; resize: vertical; padding: 10px; border-radius: 4px; border: 1px solid #ccc;"></textarea>
                </div>
            </div>

            <div class="totals-section">
                <p>Total Geral: <span id="totalAmount">R$ 0,00</span></p>
            </div>

            <div class="actions-section">
                <button type="button" class="btn-draft" onclick="saveAsDraft()">Salvar como Rascunho</button>
                <button type="button" class="btn-finalize" onclick="saveAndFinalize()">Finalizar Pedido</button>
            </div>
        </form>

    </div>

    <!-- Modal de Confirmação/Alerta Customizado -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <h2 id="customModalTitle"></h2>
            <p class="modal-message" id="customModalMessage"></p>
            <div class="modal-actions" id="customModalActions">
                <!-- Botões serão inseridos via JS -->
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais para Firebase e dados
        let auth, db, userId;
        let suppliers = [];
        let products = {}; // Usar objeto para busca rápida por SKU
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Variável de controle para edição/rascunho
        let currentPoRef = null;
        let currentCollectionName = null;

        /**
         * Configuração inicial do Firebase e autenticação.
         */
        async function setupFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not found.");
                document.getElementById('userInfo').textContent = "ERRO: Configuração do Firebase ausente.";
                return;
            }

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            auth = firebase.auth();
            db = firebase.firestore();

            try {
                 db.enablePersistence().catch(err => {
                    if (err.code === 'failed-precondition') {
                        console.warn("Persistência desabilitada: Múltiplas abas abertas.");
                    } else if (err.code === 'unimplemented') {
                        console.warn("Persistência desabilitada: Navegador não suportado.");
                    }
                });
            } catch (e) {
                console.warn("Erro ao tentar habilitar persistência:", e);
            }

            // Função de Login/Autenticação
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userInfo').textContent = `Usuário: ${user.email || 'Anônimo'}`;
                    window.loadData(); 
                } else {
                    if (initialAuthToken) {
                        try {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } catch (error) {
                            console.error("Erro na autenticação do token:", error);
                            await auth.signInAnonymously();
                        }
                    } else {
                        await auth.signInAnonymously();
                    }
                }
            });
            
            // CORRIGIDO: Define o nível de log para debug (Sintaxe correta para Firebase v8)
            firebase.firestore.setLogLevel('debug');
        }
        
        // --- Funções Auxiliares de UI/UX ---

        function logout() {
            showCustomConfirm(
                'Confirmação',
                'Tem certeza que deseja sair?',
                async () => {
                    try {
                        await auth.signOut();
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error("Erro ao fazer logout:", error);
                        showCustomAlert('Erro', 'Não foi possível sair: ' + error.message);
                    }
                }
            );
        }

        /**
         * Retorna a referência da coleção de um usuário.
         * Coleção: /artifacts/{appId}/users/{userId}/{collectionName}
         */
        function getUserCollectionRef(collectionName) {
            if (!db || !userId) {
                console.error("Firestore ou UserId não inicializados.");
                return db.collection('invalid_path');
            }
            return db.collection('artifacts').doc(appId).collection('users').doc(userId).collection(collectionName);
        }

        function formatCurrency(value) {
            if (typeof value === 'string') {
                value = parseFloat(value.replace(',', '.'));
            }
            if (isNaN(value)) return 'R$ 0,00';
            return 'R$ ' + value.toFixed(2).replace('.', ',');
        }

        // --- Funções do Modal Customizado ---

        function setupModal() {
            const modal = document.getElementById('customModal');
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showCustomAlert(title, message, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('customModalTitle').textContent = title;
            document.getElementById('customModalMessage').textContent = message;
            
            const actions = document.getElementById('customModalActions');
            actions.innerHTML = `<button class="alert-ok" onclick="closeModal('customModal')">OK</button>`;
            
            if (callback) {
                actions.querySelector('.alert-ok').onclick = () => {
                    closeModal('customModal');
                    callback();
                };
            }

            modal.style.display = 'block';
        }

        function showCustomConfirm(title, message, onYes, onNo = () => {}) {
            const modal = document.getElementById('customModal');
            document.getElementById('customModalTitle').textContent = title;
            document.getElementById('customModalMessage').textContent = message;
            
            const actions = document.getElementById('customModalActions');
            actions.innerHTML = `
                <button class="confirm-yes">Sim</button>
                <button class="confirm-no">Não</button>
            `;

            actions.querySelector('.confirm-yes').onclick = () => {
                closeModal('customModal');
                onYes();
            };
            actions.querySelector('.confirm-no').onclick = () => {
                closeModal('customModal');
                onNo();
            };

            modal.style.display = 'block';
        }

        // --- Funções de Carregamento de Dados ---
        
        async function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            const collectionRef = getUserCollectionRef('suppliers');
            
            select.innerHTML = '<option value="">Carregando Fornecedores...</option>';
            
            try {
                const snapshot = await collectionRef.orderBy('name', 'asc').get();
                suppliers = [];
                select.innerHTML = '<option value="">Selecione um Fornecedor...</option>';
                
                if (snapshot.empty) {
                    select.innerHTML = '<option value="">Nenhum fornecedor cadastrado.</option>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    suppliers.push(data);
                    const option = document.createElement('option');
                    option.value = data.cnpj; // CNPJ como valor
                    option.textContent = `${data.name} (${data.cnpj})`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error("Erro ao carregar fornecedores:", error);
                select.innerHTML = '<option value="">Erro ao carregar lista.</option>';
            }
        }

        async function loadProductSelect() {
            const collectionRef = getUserCollectionRef('products');
            products = {}; // Limpa o cache
            
            try {
                const snapshot = await collectionRef.get();
                
                if (snapshot.empty) {
                    console.warn("Nenhum produto cadastrado.");
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    products[data.sku] = data; // Armazena o produto pela SKU
                });

            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
            }
        }
        
        async function getNextPoNumber() {
            const metadataRef = getUserCollectionRef('metadata').doc('po_sequence');
            
            try {
                const doc = await db.runTransaction(async (transaction) => {
                    const docSnapshot = await transaction.get(metadataRef);
                    
                    let nextNumber;
                    if (!docSnapshot.exists) {
                        nextNumber = 1001; // Começa em um número arbitrário
                    } else {
                        nextNumber = (docSnapshot.data().lastPoNumber || 1000) + 1;
                    }

                    transaction.set(metadataRef, { lastPoNumber: nextNumber });
                    return nextNumber;
                });
                
                return doc;

            } catch (error) {
                console.error("Erro ao gerar número do pedido:", error);
                return 'ERRO-' + Date.now();
            }
        }

        // --- Funções de Manipulação de Itens ---

        let itemCounter = 0; // Contador único para IDs dos elementos
        
        function updateItemDescription(selectElement) {
            const row = selectElement.closest('tr');
            const sku = selectElement.value;
            const itemDescriptionInput = row.querySelector('.item-description');
            const itemPriceInput = row.querySelector('.item-unit-price');
            
            if (sku && products[sku]) {
                const product = products[sku];
                itemDescriptionInput.value = product.name;
                itemPriceInput.value = product.price;
            } else {
                itemDescriptionInput.value = '';
                itemPriceInput.value = '';
            }
            
            // Recalcula o total
            calculateTotal();
        }

        function addItem(itemData = {}) {
            itemCounter++;
            const itemsBody = document.getElementById('itemsBody');
            const newRow = itemsBody.insertRow();
            newRow.id = `item-row-${itemCounter}`;

            // Cria o HTML do seletor de produtos (com base no cache de products)
            let productOptions = '<option value="">Selecione...</option>';
            for (const sku in products) {
                const selected = itemData.sku === sku ? 'selected' : '';
                productOptions += `<option value="${sku}" ${selected}>${sku}</option>`;
            }

            // Define valores padrão se não houver dados
            const skuValue = itemData.sku || '';
            const quantityValue = itemData.quantity || '1';
            const priceValue = itemData.unitPrice || '0.00';
            const descriptionValue = itemData.productName || '';
            const totalValue = formatCurrency((parseFloat(quantityValue) * parseFloat(priceValue)) || 0);

            newRow.innerHTML = `
                <td><span class="item-index">${itemsBody.rows.length}</span></td>
                <td>
                    <select class="item-sku" onchange="updateItemDescription(this)" data-original-sku="${skuValue}" required>
                        ${productOptions}
                    </select>
                </td>
                <td><input type="text" class="item-description" value="${descriptionValue}" placeholder="Descrição do Produto" required></td>
                <td><input type="number" class="item-quantity" value="${quantityValue}" min="1" step="any" onchange="calculateTotal()" required></td>
                <td><input type="text" class="item-unit-price" value="${priceValue.replace('.', ',')}" oninput="this.value = this.value.replace(/[^0-9,]/g, ''); calculateTotal()" required></td>
                <td class="item-total">${totalValue}</td>
                <td class="action-col">
                    <button type="button" class="btn-remove-item" onclick="removeItem('${newRow.id}')">X</button>
                </td>
            `;

            // Garante que o item selecione o valor correto se estiver carregando dados existentes
            const skuSelect = newRow.querySelector('.item-sku');
            if (itemData.sku) {
                 skuSelect.value = itemData.sku;
            } else {
                // Se for um novo item, verifica se há apenas um produto, e seleciona-o
                if (Object.keys(products).length === 1) {
                    skuSelect.value = Object.keys(products)[0];
                    updateItemDescription(skuSelect);
                }
            }

            resequenceItems();
            calculateTotal();
        }

        function removeItem(rowId) {
            const row = document.getElementById(rowId);
            if (document.getElementById('itemsBody').rows.length > 1) {
                row.remove();
                resequenceItems();
                calculateTotal();
            } else {
                showCustomAlert('Atenção', 'O pedido deve ter pelo menos um item.');
            }
        }
        
        function resequenceItems() {
            const rows = document.getElementById('itemsBody').rows;
            for (let i = 0; i < rows.length; i++) {
                rows[i].querySelector('.item-index').textContent = i + 1;
            }
        }

        function calculateTotal() {
            let grandTotal = 0;
            const rows = document.getElementById('itemsBody').rows;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const quantity = parseFloat(row.querySelector('.item-quantity').value || 0);
                // Substitui vírgula por ponto para cálculo
                const priceText = row.querySelector('.item-unit-price').value.replace(',', '.');
                const price = parseFloat(priceText || 0);
                
                const itemTotal = quantity * price;
                grandTotal += itemTotal;
                
                row.querySelector('.item-total').textContent = formatCurrency(itemTotal);
            }
            
            document.getElementById('totalAmount').textContent = formatCurrency(grandTotal);
        }

        // --- Funções de Salvar/Finalizar ---
        
        function getPoData(status) {
            const form = document.getElementById('purchaseOrderForm');
            
            // 1. Dados do Cabeçalho
            const supplierSelect = form.elements['supplierSelect'];
            const supplierCnpj = supplierSelect.value;
            const supplierName = supplierSelect.options[supplierSelect.selectedIndex].text.split('(')[0].trim();
            const poNumber = form.elements['poNumber'].value;
            const poDate = form.elements['poDate'].value; // Salva como YYYY-MM-DD
            const notes = form.elements['notes'].value;

            if (!supplierCnpj || !poDate || !poNumber) {
                showCustomAlert('Atenção', 'Selecione o Fornecedor e preencha a Data do Pedido.');
                return null;
            }

            // 2. Itens do Pedido
            const items = [];
            const rows = document.getElementById('itemsBody').rows;
            let totalAmount = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const sku = row.querySelector('.item-sku').value;
                const name = row.querySelector('.item-description').value;
                const quantity = parseFloat(row.querySelector('.item-quantity').value || 0);
                const price = parseFloat(row.querySelector('.item-unit-price').value.replace(',', '.') || 0);

                if (!sku || !name || quantity <= 0 || price <= 0) {
                    showCustomAlert('Atenção', `O item ${i + 1} está incompleto ou tem valores inválidos.`);
                    return null;
                }
                
                const itemTotal = quantity * price;
                totalAmount += itemTotal;
                
                items.push({
                    sku: sku,
                    productName: name,
                    quantity: quantity.toFixed(2),
                    unitPrice: price.toFixed(2),
                    total: itemTotal.toFixed(2)
                });
            }

            if (items.length === 0) {
                showCustomAlert('Atenção', 'Adicione pelo menos um item ao pedido.');
                return null;
            }

            return {
                poNumber: poNumber,
                poDate: poDate,
                supplierCnpj: supplierCnpj,
                supplierName: supplierName,
                notes: notes,
                items: items,
                totalAmount: totalAmount.toFixed(2),
                status: status, // 'draft' ou 'finalized'
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        async function saveOrder(status) {
            const poData = getPoData(status);
            if (!poData) return;

            const collectionName = status === 'draft' ? 'drafts' : 'orders';
            const collectionRef = getUserCollectionRef(collectionName);

            try {
                // Se estiver editando um rascunho/pedido, a referência já está definida
                let docRef = currentPoRef;
                
                if (!docRef) {
                    // Se for novo ou se vier de um rascunho anterior que está sendo promovido a finalizado, cria a nova referência
                    docRef = collectionRef.doc(poData.poNumber.toString());
                } else if (currentCollectionName !== collectionName) {
                    // Caso raro: Se estiver promovendo um rascunho (drafts) para finalizado (orders),
                    // precisa criar uma nova referência na coleção 'orders'
                    docRef = getUserCollectionRef('orders').doc(poData.poNumber.toString());
                }
                
                // 1. Salva o documento
                await docRef.set(poData);

                // 2. Se for finalizado E veio de um rascunho, deleta o rascunho antigo
                if (status === 'finalized' && currentCollectionName === 'drafts') {
                    // currentPoRef apontava para 'drafts', agora precisa ser deletado
                    await getUserCollectionRef('drafts').doc(poData.poNumber.toString()).delete();
                }

                showCustomAlert('Sucesso', `Pedido N° ${poData.poNumber} salvo como ${status === 'draft' ? 'RASCUNHO' : 'FINALIZADO'}!`, () => {
                    if (status === 'finalized') {
                        window.location.href = 'historico.html'; // Redireciona para o histórico
                    } else {
                        window.location.href = 'rascunhos.html'; // Redireciona para os rascunhos
                    }
                });

            } catch (error) {
                console.error(`Erro ao salvar pedido como ${status}:`, error);
                showCustomAlert('Erro', `Não foi possível salvar: ${error.message}`);
            }
        }

        function saveAsDraft() {
            showCustomConfirm('Salvar Rascunho', 'Deseja salvar o pedido atual como rascunho?', () => saveOrder('draft'));
        }

        function saveAndFinalize() {
            showCustomConfirm('Finalizar Pedido', 'Tem certeza que deseja finalizar e registrar este pedido no Histórico?', () => saveOrder('finalized'));
        }

        // --- Funções de Edição (Carregamento de Parâmetros) ---

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function loadOrderForEditing(poNumber, collectionName) {
            document.title = `Editando ${collectionName === 'drafts' ? 'Rascunho' : 'Pedido'} N° ${poNumber}`;
            document.getElementById('poNumber').value = poNumber;

            currentCollectionName = collectionName;
            currentPoRef = getUserCollectionRef(collectionName).doc(poNumber);
            
            const doc = await currentPoRef.get();

            if (!doc.exists) {
                showCustomAlert('Erro', 'Pedido não encontrado para edição.', () => {
                    window.location.href = 'index.html'; // Volta para novo pedido
                });
                return;
            }

            const po = doc.data();

            // 1. Carrega o Cabeçalho
            document.getElementById('supplierSelect').value = po.supplierCnpj;
            document.getElementById('poDate').value = po.poDate;
            document.getElementById('notes').value = po.notes || '';

            // 2. Carrega os Itens
            const itemsBody = document.getElementById('itemsBody');
            itemsBody.innerHTML = ''; // Limpa a lista existente
            
            po.items.forEach(item => addItem(item));
        }


        // --- Inicialização Principal ---

        async function init() {
            if (!db || !userId) return; // Garante que o Firebase está pronto

            const poToEdit = getQueryParam('editPo'); // Se estiver editando um pedido finalizado
            const draftToEdit = getQueryParam('editDraft'); // Se estiver editando um rascunho
            
            // Carrega primeiro as listas, pois são necessárias para a interface
            await loadSupplierSelect();
            await loadProductSelect();
            
            // Verifica se está editando ou criando novo
            if (poToEdit) {
                await loadOrderForEditing(poToEdit, 'orders');
            } else if (draftToEdit) {
                await loadOrderForEditing(draftToEdit, 'drafts');
            } else {
                // Novo pedido: Define data e número
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = await getNextPoNumber();
                addItem(); // Adiciona um item inicial vazio
            }
        }

        // Função de carregamento que é chamada após a autenticação
        window.loadData = init;

        window.onload = () => {
            setupModal();
            // CHAMA A FUNÇÃO CORRIGIDA
            setupFirebase(); 
        };

        // Exporta funções para uso global (onchange/onclick no HTML)
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.calculateTotal = calculateTotal;
        window.updateItemDescription = updateItemDescription;
        window.saveAsDraft = saveAsDraft;
        window.saveAndFinalize = saveAndFinalize;
        window.resequenceItems = resequenceItems; 
        window.closeModal = closeModal; // Exporta também para o HTML do modal
        window.logout = logout;
    </script>
</body>
</html>
