<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }

        /* Barra Superior (User/Logout) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .user-info { font-weight: bold; color: #004c99; font-size: 1.1em; }
        .logout-btn { background-color: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 0.9em; }
        .logout-btn:hover { background-color: #d32f2f; }

        /* Menu de Navegação */
        .nav-menu { margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #004c99; padding-bottom: 10px; }
        .nav-menu a {
            text-decoration: none;
            color: #004c99;
            background-color: #e6f0ff;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid #004c99;
        }
        .nav-menu a:hover {
            background-color: #004c99;
            color: white;
        }
        .nav-menu .active {
            background-color: #004c99;
            color: white;
        }
        
        /* Estilos do Formulário */
        h1 { color: #004c99; margin-top: 0; }
        hr { border: 0; border-top: 2px solid #004c99; margin-bottom: 20px; }

        .form-header, .form-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 0.5fr; /* Item, Qtd, Preço, Total, Ação */
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .form-header {
            font-weight: bold;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 15px;
        }

        /* Estilo dos campos de cabeçalho (data, fornecedor, etc) */
        .info-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        /* Estilos dos botões */
        .action-buttons {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-primary, .btn-secondary, .btn-danger, .add-item-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 1em;
        }

        .btn-primary { 
            background-color: #004c99; 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: #003366; 
        }

        .btn-secondary { 
            background-color: #f0ad4e; 
            color: white; 
        }
        .btn-secondary:hover { 
            background-color: #ec971f; 
        }

        .btn-danger { 
            background-color: #d9534f; 
            color: white; 
        }
        .btn-danger:hover { 
            background-color: #c9302c; 
        }
        
        .add-item-btn {
            background-color: #5cb85c;
            color: white;
            margin-top: 15px;
            width: auto;
            align-self: flex-start;
        }
        .add-item-btn:hover {
            background-color: #4cae4c;
        }

        /* Estilos da Linha de Total */
        .total-line {
            text-align: right;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #ccc;
            color: #004c99;
        }

        /* Estilo do botão de remover item */
        .remove-item-btn {
            background-color: #ccc;
            color: #333;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            transition: background-color 0.3s;
        }
        .remove-item-btn:hover {
            background-color: #d9534f; 
            color: white;
        }

        /* Estilos do Modal (Mensagens/Confirmações) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
        }

        .modal-content h2 {
            color: #004c99;
            margin-top: 0;
        }

        .modal-content p {
            margin: 20px 0;
        }

        .modal-footer button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-footer .confirm-btn { background-color: #5cb85c; color: white; }
        .modal-footer .confirm-btn:hover { background-color: #4cae4c; }
        .modal-footer .cancel-btn { background-color: #ccc; color: #333; }
        .modal-footer .cancel-btn:hover { background-color: #bbb; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-bar">
            <div class="user-info">Usuário: <span id="currentUserEmail">Carregando...</span></div>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="active">Novo Pedido</a>
            <a href="rascunhos.html">Rascunhos</a>
            <a href="historico.html">Histórico</a>
            <a href="produtos.html">Produtos</a>
            <a href="fornecedores.html">Fornecedores</a>
        </div>
        
        <h1>Gerador de Pedido de Compra</h1>
        <hr>

        <form id="purchaseOrderForm">
            <div class="info-fields">
                <div>
                    <label for="poNumber">Nº do Pedido:</label>
                    <input type="text" id="poNumber" required readonly>
                </div>
                <div>
                    <label for="poDate">Data:</label>
                    <input type="date" id="poDate" required>
                </div>
                <div>
                    <label for="supplierSelect">Fornecedor:</label>
                    <select id="supplierSelect" required>
                        <option value="">Selecione o Fornecedor</option>
                        </select>
                </div>
            </div>
            
            <div class="form-header">
                <span>Item</span>
                <span>Qtd</span>
                <span>Preço Unit. (R$)</span>
                <span>Total (R$)</span>
                <span>Ação</span>
            </div>

            <div id="itemsContainer">
                </div>

            <button type="button" class="add-item-btn" onclick="addItem()">+ Adicionar Item</button>

            <div class="total-line">
                Total do Pedido: <span id="poTotalDisplay">R$ 0,00</span>
                <input type="hidden" id="poTotal" value="0.00">
            </div>

            <div class="action-buttons">
                <button type="button" class="btn-secondary" onclick="saveAsDraft(event)">Salvar Rascunho</button> 
                <button type="submit" class="btn-primary">Finalizar e Gerar PDF</button>
            </div>
        </form>

    </div>
    
    <div id="customModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <div id="modalFooter" class="modal-footer">
                </div>
        </div>
    </div>

    <script>
        // Variáveis globais para Firebase e contexto
        let db;
        let auth;
        let productList = {}; // Armazena produtos para lookup rápido
        let supplierList = {}; // Armazena fornecedores para lookup rápido
        const urlParams = new URLSearchParams(window.location.search);
        const poToEdit = urlParams.get('editPo'); // Para editar um pedido finalizado
        const draftToEdit = urlParams.get('editDraft'); // Para editar um rascunho

        // Configuração do Firebase, autenticação e redirecionamento (Pode ser movido para um arquivo 'common.js' no futuro)
        function setupFirebase() {
            // Se o Firebase ainda não foi inicializado, inicialize aqui (use suas credenciais)
            if (typeof firebase.apps.length === 'undefined' || firebase.apps.length === 0) {
         const firebaseConfig = {
          apiKey: "AIzaSyAXKlq9WOs_5_ilfhG13xQwNVwQa6MaBfg",
          authDomain: "farmacia-a6682.firebaseapp.com",
          projectId: "farmacia-a6682",
          storageBucket: "farmacia-a6682.firebasestorage.app",
          messagingSenderId: "144965717217",
          appId: "1:144965717217:web:de43b2316e8b7a25293ba0"
        };
                firebase.initializeApp(firebaseConfig);
            }

            db = firebase.firestore();
            auth = firebase.auth();
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Usuário logado: Carrega o e-mail e inicia o carregamento de dados
                    document.getElementById('currentUserEmail').textContent = user.email;
                    loadData();
                } else {
                    // Usuário deslogado: Redireciona para o login
                    window.location.href = 'login.html';
                }
            });
        }
        
        function logout() {
            auth.signOut().then(() => {
                // Redirecionamento já acontece no onAuthStateChanged
            }).catch((error) => {
                showCustomAlert('Erro ao Sair', 'Não foi possível fazer logout: ' + error.message);
            });
        }

        // Retorna a referência da coleção específica do usuário logado
        function getUserCollectionRef(collectionName) {
            const userId = auth.currentUser.uid;
            return db.collection('users').doc(userId).collection(collectionName);
        }

        // Funções de Modal
        let currentModalCallback;

        function setupModal() {
            const modal = document.getElementById('customModal');
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        }
        
        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        function showCustomAlert(title, message, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            
            const footer = document.getElementById('modalFooter');
            footer.innerHTML = ''; // Limpa botões anteriores
            
            const okBtn = document.createElement('button');
            okBtn.className = 'confirm-btn';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                closeModal();
                if (callback) callback();
            };
            footer.appendChild(okBtn);
            
            modal.style.display = 'block';
        }

        function showCustomConfirm(title, message, confirmCallback, cancelCallback) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            
            const footer = document.getElementById('modalFooter');
            footer.innerHTML = ''; // Limpa botões anteriores

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-btn';
            cancelBtn.textContent = 'Não';
            cancelBtn.onclick = () => {
                closeModal();
                if (cancelCallback) cancelCallback();
            };
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'confirm-btn';
            confirmBtn.textContent = 'Sim';
            confirmBtn.onclick = () => {
                closeModal();
                confirmCallback();
            };
            
            footer.appendChild(cancelBtn);
            footer.appendChild(confirmBtn);
            
            modal.style.display = 'block';
        }

        // Geração do próximo número de PO
        async function getNextPoNumber() {
            const counterRef = getUserCollectionRef('metadata').doc('poCounter');
            
            // Tenta obter e incrementar o contador
            const poCounter = await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(counterRef);
                let newPoNumber = 1;

                if (doc.exists) {
                    newPoNumber = doc.data().lastPoNumber + 1;
                }
                
                // Salva o novo valor
                transaction.set(counterRef, { lastPoNumber: newPoNumber });
                return newPoNumber;

            }).catch(error => {
                console.error("Erro na transação de PO Number:", error);
                showCustomAlert('Erro Crítico', 'Não foi possível gerar um número de pedido. Recarregue a página.');
                return null;
            });

            // Formata com 6 dígitos (ex: 000001)
            if (poCounter) {
                return String(poCounter).padStart(6, '0');
            }
            return 'ERRO';
        }

        // Carregar Fornecedores para o Select
        async function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">Carregando...</option>';
            supplierList = {}; // Limpa a lista

            try {
                const snapshot = await getUserCollectionRef('suppliers').get();
                
                select.innerHTML = '<option value="">Selecione o Fornecedor</option>';

                snapshot.forEach(doc => {
                    const supplier = doc.data();
                    supplierList[supplier.cnpj] = supplier; // Armazena para lookup
                    const option = document.createElement('option');
                    option.value = supplier.cnpj;
                    option.textContent = supplier.name;
                    select.appendChild(option);
                });
                
                if (snapshot.empty) {
                    showCustomAlert('Atenção', 'Nenhum fornecedor cadastrado. Cadastre um na página "Fornecedores" antes de criar um pedido.');
                }
                
            } catch (error) {
                console.error("Erro ao carregar fornecedores:", error);
                select.innerHTML = '<option value="">ERRO ao carregar</option>';
            }
        }
        
        // Carregar Produtos para o Select
        async function loadProductSelect() {
            productList = {}; // Limpa a lista
            try {
                const snapshot = await getUserCollectionRef('products').get();
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    productList[product.sku] = product; // Armazena para lookup
                });
                
                if (snapshot.empty) {
                    console.warn('Nenhum produto cadastrado.');
                }
                
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
            }
        }

        // Funções de Item
        let itemIndex = 0;

        function resequenceItems() {
            const items = document.querySelectorAll('.form-item');
            items.forEach((item, index) => {
                // Atualiza o ID interno (não é o índice global)
                item.setAttribute('data-index', index + 1); 
            });
        }
        
        function addItem(productData = null) {
            itemIndex++;
            const container = document.getElementById('itemsContainer');
            const item = document.createElement('div');
            item.className = 'form-item';
            item.setAttribute('data-index', itemIndex); // Usa o index global para facilitar a identificação
            
            const sku = productData ? productData.sku : '';
            const desc = productData ? productData.desc : '';
            const price = productData ? productData.price : '';
            const qty = productData ? productData.qty : '1';
            
            // Cria o campo Select/Input para o Item/Descrição
            let itemInputHtml = '';
            if (Object.keys(productList).length > 0) {
                // Se houver produtos, usa um select
                itemInputHtml = `
                    <select class="item-select" data-type="sku" onchange="updateItemDescription(this)" required>
                        <option value="">Selecione o Produto</option>
                        ${Object.values(productList).map(p => 
                            `<option value="${p.sku}" data-price="${p.price}" ${sku === p.sku ? 'selected' : ''}>${p.sku} - ${p.name}</option>`
                        ).join('')}
                    </select>
                    <input type="hidden" class="item-description" value="${desc}" required> 
                `;
            } else {
                // Se não houver produtos, usa um campo de texto livre
                itemInputHtml = `
                    <input type="text" class="item-description" placeholder="Descrição do Item" value="${desc}" required>
                    <input type="hidden" class="item-select" value="${sku}">
                `;
            }
            
            item.innerHTML = `
                <div>
                    ${itemInputHtml}
                </div>
                <div>
                    <input type="number" class="item-qty" value="${qty}" min="1" step="1" oninput="calculateTotal(this)" required>
                </div>
                <div>
                    <input type="text" class="item-price" value="${price.replace('.', ',')}" oninput="formatPrice(this); calculateTotal(this);" required>
                </div>
                <div class="item-subtotal">R$ 0,00</div>
                <div>
                    <button type="button" class="remove-item-btn" onclick="removeItem(this)">Remover</button>
                </div>
            `;
            
            container.appendChild(item);
            
            // Recalcula o total logo após adicionar/popular (se necessário)
            if (productData) {
                calculateTotal(item.querySelector('.item-qty'));
            }
            
            // Garante que pelo menos um item tem foco para o usuário começar a preencher
            if (!productData) {
                 // Foca no primeiro campo de descrição/select
                 item.querySelector('.item-select') ? item.querySelector('.item-select').focus() : item.querySelector('.item-description').focus();
            }
            
            resequenceItems();
        }

        // Funções Auxiliares
        function formatPrice(input) {
            // Remove tudo que não for número e a vírgula/ponto
            let value = input.value.replace(/[^\d,.]/g, '');
            
            // Substitui vírgula por ponto para cálculo JS
            value = value.replace(',', '.');
            
            // Garante que só há um ponto decimal
            let parts = value.split('.');
            if (parts.length > 2) {
                value = parts.shift() + '.' + parts.join('');
            }
            
            // Formata o valor de volta para o padrão BRL (vírgula)
            let displayValue = value.replace('.', ',');
            
            input.value = displayValue;
        }

        function calculateTotal(element) {
            const item = element.closest('.form-item');
            const qtyInput = item.querySelector('.item-qty');
            const priceInput = item.querySelector('.item-price');
            const subtotalDisplay = item.querySelector('.item-subtotal');
            
            let qty = parseFloat(qtyInput.value) || 0;
            // Converte para padrão americano para cálculo
            let price = parseFloat(priceInput.value.replace(',', '.')) || 0;
            
            const subtotal = qty * price;
            subtotalDisplay.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            
            // Recalcula o total geral
            let grandTotal = 0;
            document.querySelectorAll('.item-subtotal').forEach(sub => {
                // Remove R$ e substitui vírgula por ponto para somar
                const subValue = parseFloat(sub.textContent.replace('R$', '').replace(',', '.').trim()) || 0;
                grandTotal += subValue;
            });
            
            document.getElementById('poTotalDisplay').textContent = `R$ ${grandTotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('poTotal').value = grandTotal.toFixed(2); // Valor para salvar no banco
        }
        
        function removeItem(button) {
            const item = button.closest('.form-item');
            item.remove();
            calculateTotal(document.getElementById('poTotal')); // Recalcula total
            resequenceItems(); // Reorganiza os data-index
        }
        
        function updateItemDescription(select) {
            const item = select.closest('.form-item');
            const selectedOption = select.options[select.selectedIndex];
            const priceInput = item.querySelector('.item-price');
            const descInput = item.querySelector('.item-description');
            
            if (selectedOption.value) {
                // Atualiza o preço com o valor do data-price do produto selecionado
                priceInput.value = selectedOption.getAttribute('data-price').replace('.', ',');
                
                // Pega o nome do produto e usa como descrição
                const sku = selectedOption.value;
                const product = productList[sku];
                if(product) {
                     descInput.value = `${product.name} (SKU: ${product.sku})`;
                }
                
                // Coloca o foco na quantidade
                item.querySelector('.item-qty').focus();
            } else {
                // Limpa os campos se nada for selecionado
                priceInput.value = '';
                descInput.value = '';
            }
            
            calculateTotal(item.querySelector('.item-qty'));
        }

        // Funções de Salvar/Finalizar
        async function buildPoObject() {
            // Validação de campos principais
            const form = document.getElementById('purchaseOrderForm');
            if (!form.checkValidity()) {
                showCustomAlert('Atenção', 'Por favor, preencha todos os campos obrigatórios (cabeçalho e itens).');
                form.reportValidity(); // Mostra as mensagens de erro nativas
                return null;
            }
            
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierCnpj = document.getElementById('supplierSelect').value;
            const poTotal = document.getElementById('poTotal').value;
            
            // Verifica se o fornecedor existe na lista
            const supplier = supplierList[supplierCnpj];
            if (!supplier) {
                showCustomAlert('Erro', 'Fornecedor selecionado inválido. Recarregue a página.');
                return null;
            }
            
            const poItems = [];
            let allItemsValid = true;

            document.querySelectorAll('#itemsContainer .form-item').forEach(item => {
                const qty = item.querySelector('.item-qty').value;
                const price = item.querySelector('.item-price').value.replace(',', '.');
                const sku = item.querySelector('.item-select') ? item.querySelector('.item-select').value : '';
                const description = item.querySelector('.item-description').value;
                
                // Validação mínima de item
                if (parseFloat(qty) <= 0 || parseFloat(price) <= 0 || !description.trim()) {
                    allItemsValid = false;
                    return;
                }
                
                poItems.push({
                    sku: sku,
                    description: description,
                    qty: parseFloat(qty).toFixed(0),
                    price: parseFloat(price).toFixed(2),
                    subtotal: (parseFloat(qty) * parseFloat(price)).toFixed(2)
                });
            });

            if (!allItemsValid) {
                showCustomAlert('Atenção', 'Verifique se todos os itens possuem Quantidade, Preço e Descrição válidos (> 0).');
                return null;
            }

            if (poItems.length === 0) {
                 showCustomAlert('Atenção', 'O pedido deve ter pelo menos um item.');
                 return null;
            }
            
            return {
                poNumber: poNumber,
                poDate: poDate,
                supplierCnpj: supplierCnpj,
                supplierName: supplier.name,
                supplierAddress: supplier.address,
                supplierPhone: supplier.phone,
                poTotal: poTotal,
                items: poItems,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        async function saveAsDraft(event) {
            event.preventDefault(); // Não submete o formulário
            
            const poData = await buildPoObject();
            if (!poData) return;

            // Usa o número do PO como ID do rascunho
            const draftId = poData.poNumber;

            try {
                await getUserCollectionRef('drafts').doc(draftId).set(poData);
                showCustomAlert('Rascunho Salvo!', `Rascunho N° ${draftId} salvo com sucesso! Você pode continuar editando na página 'Rascunhos'.`, () => {
                    // Limpa o formulário e inicia um novo pedido
                    window.location.href = 'index.html'; 
                });
                
            } catch (error) {
                console.error("Erro ao salvar rascunho:", error);
                showCustomAlert('Erro', 'Não foi possível salvar o rascunho: ' + error.message);
            }
        }

        async function saveAndFinalize(event) {
            event.preventDefault(); 
            
            const poData = await buildPoObject();
            if (!poData) return;

            const poNumber = poData.poNumber;

            try {
                // 1. Salva na coleção 'orders'
                await getUserCollectionRef('orders').doc(poNumber).set(poData);
                
                // 2. Se for uma finalização de rascunho, remove o rascunho original
                if (draftToEdit) {
                    await getUserCollectionRef('drafts').doc(draftToEdit).delete();
                }
                
                showCustomAlert('Pedido Finalizado!', `Pedido N° ${poNumber} salvo no Histórico.`, () => {
                     // 3. Gera e exibe o PDF (Abre em nova aba)
                    printPo(poData);
                });
                
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showCustomAlert('Erro', 'Não foi possível finalizar o pedido: ' + error.message);
            }
        }
        
        // Simulação de Geração/Impressão de PO
        function printPo(poData) {
            let htmlContent = `
                <style>
                    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; font-size: 10pt; }
                    .header h1 { color: #004c99; font-size: 18pt; margin: 0 0 10px 0; border-bottom: 2px solid #004c99; padding-bottom: 5px;}
                    .header h2 { font-size: 12pt; margin: 0 0 15px 0; color: #333; }
                    .details, .supplier-info { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
                    .details div { margin-bottom: 5px; }
                    .supplier-info strong, .details strong { color: #004c99; }
                    .supplier-info { margin-top: 15px; }

                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                    th { background-color: #e6f0ff; color: #004c99; }
                    .total-row td { font-weight: bold; background-color: #f4f7f6; font-size: 12pt; text-align: right; }
                    .text-right { text-align: right; }

                    @media print {
                        .no-print { display: none; }
                    }
                </style>
                <div class="header">
                    <h1>PEDIDO DE COMPRA N° ${poData.poNumber}</h1>
                    <h2>Data de Emissão: ${poData.poDate}</h2>
                </div>
                
                <div class="supplier-info">
                    <strong>FORNECEDOR: ${poData.supplierName}</strong><br>
                    CNPJ: ${poData.supplierCnpj} | Telefone: ${poData.supplierPhone || 'N/A'}<br>
                    Endereço: ${poData.supplierAddress || 'N/A'}
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Qtd</th>
                            <th>Descrição do Item</th>
                            <th>Preço Unit.</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${poData.items.map(item => `
                            <tr>
                                <td>${item.qty}</td>
                                <td>${item.description}</td>
                                <td class="text-right">R$ ${item.price.replace('.', ',')}</td>
                                <td class="text-right">R$ ${item.subtotal.replace('.', ',')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" class="text-right">TOTAL GERAL:</td>
                            <td>R$ ${poData.poTotal.replace('.', ',')}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            // Abre uma nova janela para impressão/visualização
            const printWindow = window.open('', '_blank', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Pedido N° ' + poData.poNumber + '</title></head><body>');
            printWindow.document.write(htmlContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            // Adiciona um pequeno atraso para garantir que o conteúdo foi carregado antes de imprimir
            printWindow.onload = () => {
                 printWindow.focus(); // Foca na nova janela
                 printWindow.print(); // Abre a caixa de diálogo de impressão
            };
        }


        // Carregar Pedido para Edição (usado por rascunhos.html e historico.html)
        async function loadOrderForEditing(poNumber, collectionName) {
            document.getElementById('itemsContainer').innerHTML = ''; // Limpa itens existentes
            itemIndex = 0; // Reseta o index
            
            try {
                const doc = await getUserCollectionRef(collectionName).doc(poNumber).get();
                if (!doc.exists) {
                    showCustomAlert('Erro', `O Pedido/Rascunho N° ${poNumber} não foi encontrado.`);
                    return;
                }
                
                const po = doc.data();

                // 1. Preenche Cabeçalho
                document.getElementById('poNumber').value = po.poNumber;
                document.getElementById('poDate').value = po.poDate;
                
                // Espera o carregamento do select e depois define o valor
                const selectElement = document.getElementById('supplierSelect');
                let interval = setInterval(() => {
                    if (selectElement.options.length > 1) { // Verifica se as opções foram carregadas
                        selectElement.value = po.supplierCnpj;
                        clearInterval(interval);
                    }
                }, 100);
                
                // 2. Preenche Itens
                po.items.forEach(item => {
                    addItem({
                        sku: item.sku,
                        desc: item.description,
                        qty: item.qty,
                        price: item.price
                    });
                });
                
                // 3. Atualiza total (será feito dentro do addItem, mas chama novamente para garantir)
                calculateTotal(document.getElementById('poTotal')); 

            } catch (error) {
                console.error("Erro ao carregar pedido para edição:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o pedido/rascunho para edição.');
            }
        }


        // Função principal que orquestra o carregamento de dados
        async function init() {
            await loadSupplierSelect();
            await loadProductSelect();
            
            // Verifica se está editando ou criando novo
            if (poToEdit) {
                await loadOrderForEditing(poToEdit, 'orders');
            } else if (draftToEdit) {
                await loadOrderForEditing(draftToEdit, 'drafts');
            } else {
                // Novo pedido: Define data e número
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = await getNextPoNumber();
                addItem(); // Adiciona um item inicial vazio
            }
        }

        // Função de carregamento que é chamada após a autenticação
        window.loadData = init;

        window.onload = () => {
            setupModal();
            // CHAMA A FUNÇÃO CORRIGIDA
            setupFirebase(); 
            document.getElementById('purchaseOrderForm').addEventListener('submit', saveAndFinalize);
        };

        // Exporta funções para uso global (onchange/onclick no HTML)
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.calculateTotal = calculateTotal;
        window.updateItemDescription = updateItemDescription;
        window.saveAsDraft = saveAsDraft;
        window.saveAndFinalize = saveAndFinalize;
        window.resequenceItems = resequenceItems; 
        window.closeModal = closeModal; 
        window.logout = logout;
    </script>
</body>
</html>
