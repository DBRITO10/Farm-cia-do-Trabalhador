<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Pedido de Compra - Farmácia do Trabalhador</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Estilos Base */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        
        /* Barra Superior (User/Logout) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .user-info { font-weight: bold; color: #004c99; font-size: 14px; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c82333; }

        /* Navegação */
        .nav { display: flex; gap: 15px; margin-bottom: 25px; }
        .nav a { text-decoration: none; color: #004c99; font-weight: bold; padding: 8px 15px; border-radius: 5px; transition: background-color 0.3s; }
        .nav a:hover, .nav a.active { background-color: #e6f0ff; }
        .nav a.active { border-bottom: 3px solid #004c99; }
        
        /* Título */
        h1 { color: #333; border-bottom: 2px solid #004c99; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        
        /* Formulário e Campos */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-row { display: flex; gap: 20px; }
        .form-row > div { flex: 1; }
        input[type="text"], input[type="date"], input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }

        /* Tabela de Itens */
        .items-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .items-table th { background-color: #f2f2f2; color: #333; font-weight: bold; }
        .items-table td input, .items-table td select { border: none; padding: 5px; width: 100%; box-sizing: border-box; }
        .items-table .item-actions { text-align: center; width: 50px; }
        .items-table .remove-item-btn { 
            background: none; color: #dc3545; border: none; cursor: pointer; font-size: 1.2em; transition: color 0.3s;
        }
        .items-table .remove-item-btn:hover { color: #c82333; }
        
        /* Linha Total */
        .total-row td { font-weight: bold; background-color: #e6f0ff; border-top: 2px solid #004c99; }
        .total-row .total-label { text-align: right; }
        
        /* Botões */
        .btn-add { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        .btn-add:hover { background-color: #218838; }
        
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
        .btn-draft, .btn-finalize { padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
        .btn-draft { background-color: #ffc107; color: #333; border: none; }
        .btn-draft:hover { opacity: 0.8; }
        .btn-finalize { background-color: #007bff; color: white; border: none; }
        .btn-finalize:hover { background-color: #0056b3; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px;
            border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }

        /* Custom Alert/Confirm */
        .custom-dialog-content { text-align: center; }
        .custom-dialog-content h2 { color: #004c99; margin-top: 0; }
        .custom-dialog-actions { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .dialog-btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none; }
        .dialog-btn-primary { background-color: #007bff; color: white; }
        .dialog-btn-secondary { background-color: #6c757d; color: white; }

        .loading-overlay {
            display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8); z-index: 9999; font-size: 1.5em; color: #004c99;
        }

    </style>

    <script>
        // =============================================================
        // FIREBASE CONFIGURAÇÃO E AUTENTICAÇÃO (BLOCO PADRONIZADO)
        // =============================================================

        // Variáveis globais para Firebase
        let app, auth, db, userId;

        // Seus dados de configuração
        const firebaseConfig = {
            apiKey: "AIzaSyAXKlq9WOs_5_ilfhG13xQwNVwQa6MaFbg",
            authDomain: "farmacia-a6682.firebaseapp.com",
            projectId: "farmacia-a6682",
            storageBucket: "farmacia-a6682.firebasestorage.app",
            messagingSenderId: "144965717217",
            appId: "1:144965717217:web:de43b2316e8b7a25293ba0"
        };

        /**
         * Configura o Firebase e tenta autenticar o usuário.
         * Deve ser chamada no window.onload.
         */
        async function setupFirebase() {
            try {
                // 1. Inicializa o App
                if (typeof firebase === 'undefined') {
                    console.error("Firebase SDK não carregado.");
                    return;
                }
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }

                // 2. Inicializa os serviços
                auth = firebase.auth();
                db = firebase.firestore();
                db.settings({
                    timestampsInSnapshots: true
                });
                console.log("Firebase services initialized.");

                // 3. Autenticação (usando token customizado ou anônimo)
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (token) {
                    await auth.signInWithCustomToken(token);
                    console.log("Signed in with custom token.");
                } else {
                    await auth.signInAnonymously();
                    console.log("Signed in anonymously.");
                }
                
                // 4. Define o userId e observa o estado de autenticação
                auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated. UID:", userId);
                        // Garante que o usuário está logado e carrega os dados
                        if (window.loadData) {
                            window.loadData();
                        }
                        // Atualiza a informação do usuário na tela
                        document.getElementById('userInfoText').textContent = user.email || `ID: ${userId}`;

                    } else {
                        console.log("User signed out or failed authentication. Redirecting to login.");
                        // Redireciona para o login se não houver usuário logado (exceto na própria página de login)
                        if (window.location.pathname.indexOf('login.html') === -1) {
                            window.location.href = 'login.html';
                        }
                    }
                });

            } catch (error) {
                console.error("ERRO FATAL NA CONFIGURAÇÃO DO FIREBASE:", error);
            }
        }
        
        /**
         * Constrói a referência para a coleção do usuário.
         * @param {string} collectionName - Nome da coleção (ex: 'products', 'drafts', 'orders').
         * @returns {firebase.firestore.CollectionReference}
         */
        function getUserCollectionRef(collectionName) {
            if (!db || !userId) {
                console.error("Firebase ou userId não estão inicializados. Tentativa de acesso bloqueada.");
                return;
            }
            // Utiliza a estrutura de dados privada do Canvas
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return db.collection('artifacts').doc(appId).collection('users').doc(userId).collection(collectionName);
        }

        /**
         * Lógica de Logout
         */
        window.logout = async function() {
            try {
                await auth.signOut();
                console.log("User signed out. Redirecting to login.");
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
            }
        }

        // =============================================================
        // FIM DO BLOCO PADRONIZADO
        // =============================================================


        // Variável de controle para o próximo número de item
        let itemCounter = 0;
        // Objeto para armazenar dados de produtos para preenchimento automático
        let productCatalogue = {};
        // Objeto para armazenar rascunhos em edição
        let poToEdit = null;
        let draftToEdit = null;

        /**
         * Inicializa o modal de alerta e confirmação customizado.
         */
        function setupModal() {
            const modalHtml = `
                <div id="customModal" class="modal">
                    <div class="modal-content custom-dialog-content">
                        <span class="close-btn" onclick="closeModal()">&times;</span>
                        <h2 id="customDialogTitle"></h2>
                        <p id="customDialogMessage"></p>
                        <div id="customDialogActions" class="custom-dialog-actions"></div>
                    </div>
                </div>
            `;
            // Garante que o modal só seja adicionado uma vez
            if (!document.getElementById('customModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            window.modal = document.getElementById('customModal');
            window.modalTitle = document.getElementById('customDialogTitle');
            window.modalMessage = document.getElementById('customDialogMessage');
            window.modalActions = document.getElementById('customDialogActions');
        }

        /** Fecha o modal. */
        function closeModal() {
            if (window.modal) {
                window.modal.style.display = 'none';
            }
        }

        /**
         * Exibe um alerta customizado.
         * @param {string} title - Título da mensagem.
         * @param {string} message - Mensagem.
         * @param {function} [callback] - Função a ser executada ao fechar.
         */
        function showCustomAlert(title, message, callback = null) {
            window.modalTitle.textContent = title;
            window.modalMessage.innerHTML = message;
            window.modalActions.innerHTML = '';
            
            const okBtn = document.createElement('button');
            okBtn.className = 'dialog-btn dialog-btn-primary';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                closeModal();
                if (callback) callback();
            };
            window.modalActions.appendChild(okBtn);
            window.modal.style.display = 'flex';
        }

        /**
         * Exibe uma confirmação customizada.
         * @param {string} title - Título da confirmação.
         * @param {string} message - Mensagem.
         * @param {function} onConfirm - Função a ser executada se confirmar.
         * @param {function} [onCancel] - Função a ser executada se cancelar.
         */
        function showCustomConfirm(title, message, onConfirm, onCancel = null) {
            window.modalTitle.textContent = title;
            window.modalMessage.innerHTML = message;
            window.modalActions.innerHTML = '';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'dialog-btn dialog-btn-secondary';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.onclick = () => {
                closeModal();
                if (onCancel) onCancel();
            };
            window.modalActions.appendChild(cancelBtn);

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'dialog-btn dialog-btn-primary';
            confirmBtn.textContent = 'Confirmar';
            confirmBtn.onclick = () => {
                closeModal();
                onConfirm();
            };
            window.modalActions.appendChild(confirmBtn);

            window.modal.style.display = 'flex';
        }


        /**
         * Carrega a lista de fornecedores para o dropdown.
         */
        async function loadSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- Selecione um Fornecedor --</option>';

            try {
                const snapshot = await getUserCollectionRef('suppliers').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = data.cnpj; // CNPJ como valor
                    option.textContent = data.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar fornecedores:", error);
                showCustomAlert('Erro', 'Não foi possível carregar a lista de fornecedores.');
            }
        }

        /**
         * Carrega a lista de produtos para preenchimento automático.
         */
        async function loadProductSelect() {
            productCatalogue = {}; // Reset

            try {
                const snapshot = await getUserCollectionRef('products').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    productCatalogue[data.sku] = data; // Chave: SKU
                });
                // Garante que os selects de produtos nos itens existentes sejam atualizados
                updateAllProductSelectors();
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o catálogo de produtos.');
            }
        }

        /**
         * Atualiza os <select> de produto em todas as linhas de item.
         */
        function updateAllProductSelectors() {
            document.querySelectorAll('.product-select').forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="">-- Selecione um Produto --</option>';

                const products = Object.values(productCatalogue).sort((a, b) => a.name.localeCompare(b.name));
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.sku;
                    option.textContent = `${product.name} (${product.sku})`;
                    select.appendChild(option);
                });

                // Restaura o valor selecionado
                if (selectedValue) {
                    select.value = selectedValue;
                }
            });
        }

        /**
         * Adiciona uma nova linha de item à tabela.
         */
        function addItem(sku = '', description = '', qty = '', unitPrice = '', total = '') {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.id = `itemRow${itemCounter}`;
            newRow.setAttribute('data-index', itemCounter);
            
            const cellIndex = newRow.insertCell();
            cellIndex.className = 'item-index';
            cellIndex.textContent = tableBody.rows.length; // Número sequencial

            const cellProduct = newRow.insertCell();
            const cellDescription = newRow.insertCell();
            const cellQty = newRow.insertCell();
            const cellUnitPrice = newRow.insertCell();
            const cellTotal = newRow.insertCell();
            const cellActions = newRow.insertCell();

            // Select de Produto (SKU)
            const productSelect = document.createElement('select');
            productSelect.className = 'product-select';
            productSelect.name = `itemSku_${itemCounter}`;
            productSelect.setAttribute('onchange', `window.updateItemDescription('${itemCounter}')`);
            productSelect.required = true;
            cellProduct.appendChild(productSelect);
            
            // Preenche o select com os produtos carregados
            updateAllProductSelectors();
            productSelect.value = sku;


            // Descrição (Preenchida ou Manual)
            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.name = `itemDescription_${itemCounter}`;
            descriptionInput.value = description;
            descriptionInput.placeholder = 'Descrição (auto-preenchida ou manual)';
            cellDescription.appendChild(descriptionInput);

            // Quantidade
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.name = `itemQty_${itemCounter}`;
            qtyInput.value = qty;
            qtyInput.min = '1';
            qtyInput.step = '1';
            qtyInput.required = true;
            qtyInput.setAttribute('oninput', `window.calculateTotal('${itemCounter}')`);
            cellQty.appendChild(qtyInput);

            // Preço Unitário
            const unitPriceInput = document.createElement('input');
            unitPriceInput.type = 'text';
            unitPriceInput.name = `itemUnitPrice_${itemCounter}`;
            unitPriceInput.value = unitPrice ? unitPrice.replace('.', ',') : '';
            unitPriceInput.placeholder = '0,00';
            unitPriceInput.required = true;
            unitPriceInput.setAttribute('oninput', `window.calculateTotal('${itemCounter}'); window.applyInputFormat(this, 'price')`);
            cellUnitPrice.appendChild(unitPriceInput);

            // Total da Linha
            const totalSpan = document.createElement('span');
            totalSpan.id = `itemTotal_${itemCounter}`;
            totalSpan.textContent = total ? total.replace('.', ',') : '0,00';
            cellTotal.appendChild(totalSpan);

            // Botão de Remover
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-item-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'Remover Item';
            removeBtn.setAttribute('onclick', `window.removeItem('${newRow.id}')`);
            cellActions.className = 'item-actions';
            cellActions.appendChild(removeBtn);

            // Se SKU foi fornecido (em edição), atualiza a descrição e recalcula
            if (sku) {
                window.updateItemDescription(itemCounter);
                window.calculateTotal(itemCounter);
            }
            
            itemCounter++;
            calculateGrandTotal();
        }

        /**
         * Recalcula o total da linha e o total geral.
         * @param {string} index - O data-index do item (parte do ID).
         */
        function calculateTotal(index) {
            const qtyInput = document.querySelector(`input[name="itemQty_${index}"]`);
            const priceInput = document.querySelector(`input[name="itemUnitPrice_${index}"]`);
            const totalSpan = document.getElementById(`itemTotal_${index}`);

            if (!qtyInput || !priceInput || !totalSpan) return;

            // Remove a máscara de preço e converte para float (usando '.' como separador decimal)
            const priceText = priceInput.value.replace(/\./g, '').replace(',', '.');
            const qty = parseFloat(qtyInput.value) || 0;
            const unitPrice = parseFloat(priceText) || 0;

            const total = (qty * unitPrice).toFixed(2);
            
            // Exibe o total formatado com ','
            totalSpan.textContent = total.replace('.', ',');

            calculateGrandTotal();
        }

        /**
         * Recalcula o total geral do pedido.
         */
        function calculateGrandTotal() {
            const allTotalSpans = document.querySelectorAll('[id^="itemTotal_"]');
            let grandTotal = 0;

            allTotalSpans.forEach(span => {
                // Pega o texto, remove a máscara de preço e converte para float
                const totalText = span.textContent.replace(/\./g, '').replace(',', '.');
                grandTotal += parseFloat(totalText) || 0;
            });

            // Exibe o total geral formatado com ','
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2).replace('.', ',');
        }


        /**
         * Remove uma linha de item da tabela.
         * @param {string} rowId - O ID da linha a ser removida.
         */
        function removeItem(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                window.resequenceItems();
                calculateGrandTotal();
            }
        }

        /**
         * Atualiza os números sequenciais dos itens.
         */
        function resequenceItems() {
            const rows = document.getElementById('itemsTableBody').rows;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                // Atualiza o número de sequência na primeira célula
                row.cells[0].textContent = i + 1;
            }
        }


        /**
         * Preenche a descrição do item com base no produto selecionado.
         * @param {string} index - O data-index do item.
         */
        function updateItemDescription(index) {
            const select = document.querySelector(`select[name="itemSku_${index}"]`);
            const descriptionInput = document.querySelector(`input[name="itemDescription_${index}"]`);
            const unitPriceInput = document.querySelector(`input[name="itemUnitPrice_${index}"]`);
            
            if (!select || !descriptionInput || !unitPriceInput) return;

            const sku = select.value;

            if (sku && productCatalogue[sku]) {
                const product = productCatalogue[sku];
                descriptionInput.value = product.desc;
                // Preço padrão (já formatado com vírgula)
                unitPriceInput.value = product.price.replace('.', ','); 
            } else {
                descriptionInput.value = '';
                unitPriceInput.value = '';
            }
            // Garante que o total seja recalculado após a atualização do preço
            calculateTotal(index);
        }

        /**
         * Aplica máscara de formatação (preço) ao campo de input.
         * @param {HTMLInputElement} input - O campo de input.
         * @param {string} formatType - O tipo de formatação ('price').
         */
        function applyInputFormat(input, formatType) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito

            if (formatType === 'price') {
                if (value.length > 2) {
                    value = value.padStart(3, '0'); // Garante pelo menos 0,00
                    // Insere a vírgula antes dos dois últimos dígitos
                    value = value.substring(0, value.length - 2) + ',' + value.substring(value.length - 2);
                } else if (value.length > 0) {
                     // Caso 1 dígito: 0,0x. Caso 2 dígitos: 0,xx
                    value = '0,' + value.padStart(2, '0');
                } else {
                    value = '';
                }
                
                // Formatação para milhares (pontos)
                const parts = value.split(',');
                if (parts[0]) {
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                }
                value = parts.join(',');

                input.value = value;
            }
        }


        /**
         * Obtém o próximo número de pedido sequencial do Firestore.
         */
        async function getNextPoNumber() {
            const counterRef = getUserCollectionRef('metadata').doc('poCounter');
            
            try {
                // Transação para garantir atomicidade ao incrementar
                const newNumber = await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(counterRef);
                    let currentNumber = 0;
                    if (doc.exists) {
                        currentNumber = doc.data().lastNumber || 0;
                    }
                    const nextNumber = currentNumber + 1;
                    transaction.set(counterRef, { lastNumber: nextNumber });
                    return nextNumber;
                });
                
                // Formata o número (ex: 1 -> 000001)
                return String(newNumber).padStart(6, '0');

            } catch (error) {
                console.error("Erro na transação de número do pedido:", error);
                showCustomAlert('Erro', 'Não foi possível gerar um novo número de Pedido. Use um número manual.');
                return 'ERRO';
            }
        }


        /**
         * Cria o objeto de pedido (PO) a partir dos dados do formulário.
         * @param {string} status - 'draft' ou 'finalized'.
         */
        function buildOrderObject(status) {
            const poNumber = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const supplierCnpj = document.getElementById('supplierSelect').value;
            const supplierName = document.getElementById('supplierSelect').options[document.getElementById('supplierSelect').selectedIndex].text;
            
            const items = [];
            let isValid = true;

            const rows = document.getElementById('itemsTableBody').rows;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const index = row.getAttribute('data-index');

                const sku = document.querySelector(`select[name="itemSku_${index}"]`).value;
                const description = document.querySelector(`input[name="itemDescription_${index}"]`).value;
                const qtyInput = document.querySelector(`input[name="itemQty_${index}"]`);
                const unitPriceInput = document.querySelector(`input[name="itemUnitPrice_${index}"]`);
                const totalSpan = document.getElementById(`itemTotal_${index}`);

                // Validação mínima
                if (!sku || !qtyInput.value || !unitPriceInput.value) {
                    isValid = false;
                    break;
                }

                // Conversão de preço (do formato BR para US)
                const unitPrice = parseFloat(unitPriceInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                const total = parseFloat(totalSpan.textContent.replace(/\./g, '').replace(',', '.')) || 0;

                items.push({
                    sku: sku,
                    desc: description,
                    qty: parseInt(qtyInput.value, 10),
                    unitPrice: unitPrice.toFixed(2), // Salva como string US com 2 casas
                    total: total.toFixed(2), // Salva como string US com 2 casas
                });
            }

            if (!isValid) {
                showCustomAlert('Atenção', 'Todos os campos SKU, Quantidade e Preço Unitário nos itens devem ser preenchidos.');
                return null;
            }

            const grandTotal = document.getElementById('grandTotal').textContent.replace(/\./g, '').replace(',', '.');

            const po = {
                poNumber: poNumber,
                poDate: poDate,
                supplierCnpj: supplierCnpj,
                supplierName: supplierName,
                items: items,
                grandTotal: grandTotal,
                status: status,
                createdAt: poToEdit || draftToEdit ? null : firebase.firestore.FieldValue.serverTimestamp(), // Usa timestamp apenas na criação
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            
            return po;
        }

        /**
         * Salva o pedido como Rascunho no Firestore.
         */
        async function saveAsDraft() {
            const po = buildOrderObject('draft');
            if (!po) return;

            const poNumber = po.poNumber;

            try {
                // Pega a referência para a coleção de rascunhos
                const draftRef = getUserCollectionRef('drafts').doc(poNumber);
                await draftRef.set(po);
                
                showCustomAlert('Rascunho Salvo!', `O pedido N° ${poNumber} foi salvo como Rascunho com sucesso.`);

            } catch (error) {
                console.error("Erro ao salvar rascunho:", error);
                showCustomAlert('Erro', 'Não foi possível salvar o rascunho: ' + error.message);
            }
        }


        /**
         * Salva o pedido como Finalizado (Histórico) no Firestore.
         */
        async function saveAndFinalize() {
            const po = buildOrderObject('finalized');
            if (!po) return;

            // Validação de campos obrigatórios antes de finalizar
            if (!po.supplierCnpj || !po.poDate || po.items.length === 0) {
                 showCustomAlert('Atenção', 'Por favor, preencha o Fornecedor, Data e adicione pelo menos um item válido antes de finalizar.');
                 return;
            }

            // Confirmação para Finalização
            showCustomConfirm(
                'Finalizar Pedido?',
                `Confirma a finalização do Pedido N° ${po.poNumber}? Ele será movido para o Histórico.`,
                async () => {
                    const poNumber = po.poNumber;

                    try {
                        // 1. Salvar no Histórico (Coleção 'orders')
                        const historyRef = getUserCollectionRef('orders').doc(poNumber);
                        await historyRef.set(po);
                        
                        // 2. Se estava editando um rascunho, remove-o
                        if (draftToEdit) {
                            const draftRef = getUserCollectionRef('drafts').doc(poNumber);
                            await draftRef.delete();
                            console.log(`Rascunho ${poNumber} excluído após finalização.`);
                        }

                        showCustomAlert('Pedido Finalizado!', `O Pedido N° ${poNumber} foi salvo com sucesso no Histórico!`, () => {
                            // Redireciona após a finalização
                            window.location.href = 'historico.html';
                        });
                        
                    } catch (error) {
                        console.error("Erro ao finalizar pedido:", error);
                        showCustomAlert('Erro', 'Não foi possível finalizar o pedido: ' + error.message);
                    }
                }
            );
        }

        /**
         * Carrega um pedido (rascunho ou finalizado) para edição.
         * @param {string} poNumber - Número do pedido.
         * @param {string} collection - Coleção ('drafts' ou 'orders').
         */
        async function loadOrderForEditing(poNumber, collection) {
            const docRef = getUserCollectionRef(collection).doc(poNumber);
            try {
                const doc = await docRef.get();

                if (doc.exists) {
                    const po = doc.data();

                    // Preenche campos principais
                    document.getElementById('poNumber').value = po.poNumber;
                    document.getElementById('poDate').value = po.poDate;
                    document.getElementById('supplierSelect').value = po.supplierCnpj; // Seleciona o fornecedor

                    // Limpa e popula os itens
                    const tableBody = document.getElementById('itemsTableBody');
                    tableBody.innerHTML = '';
                    itemCounter = 0; // Reseta o contador
                    
                    po.items.forEach(item => {
                        addItem(
                            item.sku, 
                            item.desc, 
                            item.qty.toString(), 
                            item.unitPrice, 
                            item.total
                        );
                    });

                    // Recalcula o total geral
                    calculateGrandTotal();

                    // Se estiver editando um pedido finalizado, muda a ação do botão
                    if (collection === 'orders') {
                        document.querySelector('.btn-finalize').textContent = 'Atualizar Pedido';
                        document.title = `Editar Pedido N° ${po.poNumber}`;
                        showCustomAlert('Aviso', 'Você está editando um pedido já FINALIZADO no Histórico. A atualização substituirá a versão anterior.');
                    } else if (collection === 'drafts') {
                        document.title = `Editar Rascunho N° ${po.poNumber}`;
                        showCustomAlert('Aviso', 'Você está editando um RASCUNHO. Lembre-se de Finalizar para movê-lo para o Histórico.');
                    }

                } else {
                    showCustomAlert('Erro', `Pedido N° ${poNumber} não encontrado na coleção ${collection}.`);
                    window.location.href = 'index.html'; // Volta para a criação de novo pedido
                }

            } catch (error) {
                console.error("Erro ao carregar pedido para edição:", error);
                showCustomAlert('Erro', 'Não foi possível carregar o pedido para edição: ' + error.message);
            }
        }

        /**
         * Função de inicialização principal.
         */
        async function init() {
            // Carrega parâmetros de URL (se houver)
            const urlParams = new URLSearchParams(window.location.search);
            poToEdit = urlParams.get('editPo'); // Pedido Finalizado
            draftToEdit = urlParams.get('editDraft'); // Rascunho

            // Carrega primeiro as listas, pois são necessárias para a interface
            await loadSupplierSelect();
            await loadProductSelect();
            
            // Verifica se está editando ou criando novo
            if (poToEdit) {
                await loadOrderForEditing(poToEdit, 'orders');
            } else if (draftToEdit) {
                await loadOrderForEditing(draftToEdit, 'drafts');
            } else {
                // Novo pedido: Define data e número
                document.getElementById('poDate').value = new Date().toISOString().slice(0, 10);
                document.getElementById('poNumber').value = await getNextPoNumber();
                addItem(); // Adiciona um item inicial vazio
            }
        }

        // Função de carregamento que é chamada após a autenticação
        window.loadData = init;

        window.onload = () => {
            setupModal();
            // CHAMA A FUNÇÃO CORRIGIDA DE SETUP DO FIREBASE
            setupFirebase(); 
        };

        // Exporta funções para uso global (onchange/onclick no HTML)
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.calculateTotal = calculateTotal;
        window.updateItemDescription = updateItemDescription;
        window.saveAsDraft = saveAsDraft;
        window.saveAndFinalize = saveAndFinalize;
        window.resequenceItems = resequenceItems; 
        window.applyInputFormat = applyInputFormat;
        window.closeModal = closeModal; // Exporta também para o HTML do modal
    </script>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">Aguarde, carregando dados do sistema...</div>
    <div class="container" style="display:none;" id="mainContent">

        <div class="top-bar">
            <div class="user-info">Bem-vindo, <span id="userInfoText">Carregando...</span></div>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <div class="nav">
            <a href="index.html" class="active">Novo Pedido</a>
            <a href="rascunhos.html">Rascunhos</a>
            <a href="historico.html">Histórico</a>
            <a href="produtos.html">Catálogo de Produtos</a>
            <a href="fornecedores.html">Cadastro de Fornecedores</a>
        </div>

        <h1>Gerador de Pedido de Compra</h1>

        <form id="poForm">
            <!-- Informações do Pedido -->
            <div class="form-row">
                <div class="form-group">
                    <label for="poNumber">Número do Pedido</label>
                    <input type="text" id="poNumber" readonly>
                </div>
                <div class="form-group">
                    <label for="poDate">Data do Pedido</label>
                    <input type="date" id="poDate" required>
                </div>
            </div>

            <!-- Seleção de Fornecedor -->
            <div class="form-group">
                <label for="supplierSelect">Fornecedor</label>
                <select id="supplierSelect" required>
                    <option value="">-- Carregando Fornecedores --</option>
                </select>
            </div>

            <!-- Itens do Pedido -->
            <h2>Itens</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>SKU</th>
                        <th>Descrição</th>
                        <th style="width: 80px;">Qtde</th>
                        <th style="width: 120px;">Preço Unit. (R$)</th>
                        <th style="width: 120px;">Total (R$)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Itens serão adicionados aqui -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5" class="total-label">TOTAL GERAL</td>
                        <td><span id="grandTotal">0,00</span></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <button type="button" class="btn-add" onclick="addItem()">+ Adicionar Item</button>

            <!-- Ações -->
            <div class="form-actions">
                <button type="button" class="btn-draft" onclick="saveAsDraft()">Memorizar (Rascunho)</button>
                <button type="button" class="btn-finalize" onclick="saveAndFinalize()">Salvar e Finalizar Pedido</button>
            </div>
        </form>
    </div>
    
    <!-- O modal customizado será adicionado via setupModal() -->
</body>
</html>
